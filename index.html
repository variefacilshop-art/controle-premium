<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#020617; --bg2:#0b1225;
      --card: rgba(7, 12, 26, .78);
      --card2: rgba(7, 12, 26, .60);
      --stroke: rgba(148, 163, 184, .14);
      --text: #e5e7eb; --muted: rgba(226, 232, 240, .72);
      --cyan:#00c2ff; --cyan2:#33d2ff;
      --red:#ef4444; --green:#22c55e;
      --shadow: 0 20px 80px rgba(0,0,0,.55);
      --glow: 0 0 0 1px rgba(0,194,255,.18), 0 0 60px rgba(0,194,255,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(0,194,255,.16), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(99,102,241,.10), transparent 55%),
        radial-gradient(900px 700px at 40% 120%, rgba(34,197,94,.08), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex; justify-content:center;
      padding: 34px 18px;
    }
    .wrap{ width: 100%; max-width: 1120px; }
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 14px;}
    .brand{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px; border-radius: 999px;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: var(--glow);
    }
    .diamond{
      width: 34px; height: 34px; display:grid; place-items:center;
      border-radius: 12px;
      background: rgba(0,194,255,.12);
      border: 1px solid rgba(0,194,255,.25);
    }
    .brand h1{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .brand p{ margin:0; font-size: 12px; color: var(--muted); margin-top:2px; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px; border-radius: 999px;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size: 12px;
    }
    .btn{
      border:none; cursor:pointer; border-radius: 12px;
      padding: 10px 14px; font-weight: 900; font-size: 13px;
      transition: transform .06s ease, opacity .2s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(180deg, var(--cyan2), var(--cyan)); color:#001018; box-shadow: 0 16px 60px rgba(0,194,255,.20); }
    .btn-danger{ background: linear-gradient(180deg, #ff6b6b, var(--red)); color:#fff; box-shadow: 0 16px 60px rgba(239,68,68,.20); }
    .btn-ghost{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.14);
      color: rgba(226,232,240,.85);
    }
    .btn-icon{
      width: 36px; height: 36px; padding: 0;
      border-radius: 12px;
      font-weight: 900;
    }
    .btn-icon-danger{
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.22);
      color: #ffb4b4;
    }
    .btn-icon-edit{
      background: rgba(0,194,255,.10);
      border: 1px solid rgba(0,194,255,.22);
      color: rgba(200,245,255,.95);
    }

    .tabs{ display:flex; gap:10px; align-items:center; margin: 10px 0 16px; flex-wrap:wrap; }
    .tab{
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.45);
      color: var(--muted);
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .tab.active{
      background: rgba(0,194,255,.14);
      border-color: rgba(0,194,255,.25);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(0,194,255,.10);
    }

    .grid{ display:grid; grid-template-columns: 1fr 1.25fr; gap: 16px; }
    @media (max-width: 960px){ .grid{ grid-template-columns: 1fr; } }

    .dashGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 960px){ .dashGrid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .head{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .head h2{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .card .head span{ color: var(--muted); font-size: 12px; }
    .card .body{ padding: 16px; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
    label{ font-size: 12px; color: var(--muted); }
    input, select{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.55);
      color: var(--text);
      outline: none;
    }
    select{ cursor:pointer; }
    input::placeholder{ color: rgba(226,232,240,.45); }
    input:focus, select:focus{ border-color: rgba(0,194,255,.35); box-shadow: 0 0 0 4px rgba(0,194,255,.10); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 520px){ .row{ grid-template-columns: 1fr; } }

    .hint{ font-size: 12px; color: rgba(226,232,240,.55); margin-top: 4px; }

    .summary{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kpi{
      background: var(--card2);
      border: 1px solid rgba(148,163,184,.10);
      border-radius: 16px;
      padding: 14px;
    }
    .kpi .k{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .v{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .kpi .v.green{ color: var(--green); }
    .kpi .v.red{ color: #ff8080; }

    .list{ max-height: 520px; overflow:auto; }
    .item{
      display:flex; justify-content:space-between; gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      align-items:center;
    }
    .item:last-child{ border-bottom:none; }
    .leftcol{ display:flex; flex-direction:column; gap:6px; min-width:0; flex:1; }
    .desc{ font-weight: 800; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{
      font-size: 11px; color: rgba(226,232,240,.75);
      padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.40);
    }
    .badge.in{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .badge.out{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); }
    .badge.cat{ border-color: rgba(0,194,255,.22); background: rgba(0,194,255,.08); }

    .rightcol{ display:flex; align-items:center; gap:10px; }
    .amount{ font-weight: 900; white-space: nowrap; font-size: 14px; }
    .amount.pos{ color: var(--green); }
    .amount.neg{ color: #ff8080; }
    .empty{ padding: 18px 16px; color: rgba(226,232,240,.60); font-size: 13px; }
    .hidden{ display:none !important; }

    .barWrap{
      width: 100%; height: 12px; border-radius: 999px;
      background: rgba(148,163,184,.10);
      border: 1px solid rgba(148,163,184,.10);
      overflow:hidden;
    }
    .bar{
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--cyan), rgba(34,197,94,.85));
      border-radius: 999px;
      transition: width .25s ease;
    }

    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px){ .twoCol{ grid-template-columns: 1fr; } }

    .toast{
      position: fixed; left: 18px; bottom: 18px;
      max-width: 560px;
      background: rgba(2,6,23,.90);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index: 9999;
    }
    .toast.show{ display:flex; }
    .toast b{ display:block; margin-bottom:2px; }
    .toast .small{ font-size: 12px; color: rgba(226,232,240,.75); }

    .modalOverlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 9998;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: 100%; max-width: 560px;
      background: rgba(2,6,23,.92);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHead h3{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .modalBody{ padding: 16px; color: rgba(226,232,240,.80); font-size: 13px; }
    .modalFoot{
      padding: 14px 16px;
      border-top: 1px solid rgba(148,163,184,.12);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .catBox{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 12px;
    }
    .catRow{
      display:flex; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      align-items:center;
    }
    .catRow:last-child{ border-bottom:none; }
    .catName{ font-weight: 900; font-size: 13px; color: rgba(226,232,240,.92); }
    .catNums{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.40);
      color: rgba(226,232,240,.82);
      white-space:nowrap;
    }
    .chip.in{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .chip.out{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); }

    .headActions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .canvasWrap{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 12px;
      height: 260px;
    }

    .topCats{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .topItem{
      display:flex; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      align-items:center;
    }
    .topItem:last-child{ border-bottom:none; }
    .topLeft{ display:flex; flex-direction:column; gap:4px; }
    .topTitle{ font-weight: 900; font-size: 13px; }
    .topSub{ font-size: 12px; color: rgba(226,232,240,.65); }
    .topVal{ font-weight: 900; white-space: nowrap; }

    .searchBox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .searchBox input{ flex: 1; min-width: 220px; }
    .smallNote{ font-size: 12px; color: rgba(226,232,240,.60); }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="diamond">üíé</div>
        <div>
          <h1>Controle Premium</h1>
          <p>Valores em Real (R$) ‚Ä¢ Pessoal</p>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="pillEmail">N√£o logado</div>
        <button class="btn btn-danger hidden" id="btnSair" type="button">Sair</button>
      </div>
    </div>

    <div class="tabs hidden" id="tabs">
      <button class="tab active" id="tabFin" type="button">Finan√ßas</button>
      <button class="tab" id="tabMeta" type="button">Metas</button>
      <button class="tab" id="tabDash" type="button">Dashboard</button>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginBox">
      <div class="head">
        <h2>Entrar</h2>
        <span>Login com Google</span>
      </div>
      <div class="body">
        <button class="btn btn-primary" id="btnLogin" type="button">Entrar com Google</button>
        <div class="hint">Cache: <strong>Ctrl + Shift + R</strong></div>
      </div>
    </div>

    <!-- FINAN√áAS -->
    <div class="grid hidden" id="financasBox">
      <div class="card">
        <div class="head">
          <h2>Adicionar lan√ßamento</h2>
          <span>Busca + Editar</span>
        </div>
        <div class="body">

          <div class="field">
            <label>M√™s selecionado</label>
            <select id="mesSelect"></select>
          </div>

          <div class="row">
            <div class="field">
              <label>Filtro de categoria</label>
              <select id="filtroCategoria"></select>
            </div>
            <div class="field">
              <label>Tipo</label>
              <select id="tipo">
                <option value="entrada">Entrada</option>
                <option value="saida">Sa√≠da</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Data (DD/MM/AAAA)</label>
              <input id="data" placeholder="Ex: 03/02/2026" />
            </div>
            <div class="field">
              <label>Valor (R$)</label>
              <input id="valor" type="number" placeholder="Ex: 100 (sempre positivo)" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Categoria</label>
              <select id="categoria">
                <option value="Vendas">Vendas</option>
                <option value="Tr√°fego">Tr√°fego</option>
                <option value="Fornecedor">Fornecedor</option>
                <option value="Embalagem">Embalagem</option>
                <option value="Frete/Log√≠stica">Frete/Log√≠stica</option>
                <option value="Impostos/Taxas">Impostos/Taxas</option>
                <option value="Mercado">Mercado</option>
                <option value="Lazer">Lazer</option>
                <option value="Outros">Outros</option>
              </select>
              <div class="hint">Voc√™ pode mudar essa lista depois.</div>
            </div>
            <div class="field">
              <label>Descri√ß√£o</label>
              <input id="descricao" placeholder="Ex: Venda Shopify, Mercado, Uber..." />
            </div>
          </div>

          <button class="btn btn-primary" id="btnSalvar" type="button">Salvar lan√ßamento</button>
          <div class="hint">Sa√≠da vira negativo automaticamente. Meta usa s√≥ entradas.</div>

          <div style="height:14px"></div>

          <div class="summary">
            <div class="kpi">
              <div class="k">Entradas</div>
              <div class="v green" id="kpiEntradas">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">Sa√≠das</div>
              <div class="v red" id="kpiSaidas">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">Saldo</div>
              <div class="v" id="kpiSaldo">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">Registros</div>
              <div class="v" id="kpiQtd">0</div>
            </div>
          </div>

          <div class="catBox">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px">
              <div style="font-weight:900">Resumo por categoria</div>
              <div style="font-size:12px;color:rgba(226,232,240,.62)" id="catHint">M√™s selecionado</div>
            </div>
            <div id="catResumo" class="empty">Sem dados ainda.</div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <h2>Movimenta√ß√µes</h2>
            <span>Buscar + Editar + Exportar</span>
          </div>
          <div class="headActions">
            <button class="btn btn-ghost" id="btnExportar" type="button">‚¨áÔ∏è Exportar CSV</button>
          </div>
        </div>
        <div class="body" style="padding-top:12px">
          <div class="searchBox">
            <input id="busca" placeholder="üîé Buscar na descri√ß√£o (ex: mercado, fornecedor, venda...)" />
            <div class="smallNote" id="buscaInfo">Mostrando tudo</div>
          </div>
        </div>
        <div class="list" id="lista">
          <div class="empty">Nenhum registro neste m√™s.</div>
        </div>
      </div>
    </div>

    <!-- METAS -->
    <div class="hidden" id="metasBox">
      <div class="card">
        <div class="head">
          <h2>Metas & Progresso</h2>
          <span>Progresso conta s√≥ ENTRADAS</span>
        </div>
        <div class="body">

          <div class="twoCol">
            <div class="field">
              <label>M√™s da meta (MM/AAAA)</label>
              <input id="metaMes" placeholder="Ex: 02/2026" />
            </div>
            <div class="field">
              <label>Meta do m√™s (R$)</label>
              <input id="metaValor" type="number" placeholder="Ex: 3000" />
            </div>
          </div>

          <button class="btn btn-primary" id="btnSalvarMeta" type="button">Salvar meta</button>

          <div style="height:18px"></div>

          <div class="summary">
            <div class="kpi">
              <div class="k">Meta</div>
              <div class="v" id="metaKpi">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">Entradas do m√™s</div>
              <div class="v green" id="ganheiKpi">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">Falta</div>
              <div class="v red" id="faltaKpi">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="k">M√©dia por dia</div>
              <div class="v" id="mediaDiaKpi">R$ 0,00</div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="field">
            <label>Progresso</label>
            <div class="barWrap"><div class="bar" id="bar"></div></div>
            <div class="hint" id="progressText">0% da meta</div>
          </div>

        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="hidden" id="dashboardBox">
      <div class="dashGrid">
        <div class="card">
          <div class="head">
            <h2>Entradas x Sa√≠das</h2>
            <span>√öltimos 6 meses</span>
          </div>
          <div class="body">
            <div class="canvasWrap">
              <canvas id="chartBars"></canvas>
            </div>
            <div class="hint" id="dashHint1">Carregando‚Ä¶</div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <h2>Saldo</h2>
            <span>√öltimos 6 meses</span>
          </div>
          <div class="body">
            <div class="canvasWrap">
              <canvas id="chartSaldo"></canvas>
            </div>
            <div class="hint" id="dashHint2">Carregando‚Ä¶</div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <h2>Top categorias do m√™s</h2>
            <span>Baseado no m√™s selecionado</span>
          </div>
          <div class="body">
            <div class="topCats" id="topCatsBox">
              <div class="empty">Sem dados ainda.</div>
            </div>
            <div class="hint" id="dashHint3">Dica: use o seletor de m√™s na aba Finan√ßas.</div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <h2>Resumo r√°pido</h2>
            <span>M√™s selecionado</span>
          </div>
          <div class="body">
            <div class="summary">
              <div class="kpi">
                <div class="k">Entradas</div>
                <div class="v green" id="dashEntradas">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="k">Sa√≠das</div>
                <div class="v red" id="dashSaidas">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="k">Saldo</div>
                <div class="v" id="dashSaldo">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="k">Registros</div>
                <div class="v" id="dashQtd">0</div>
              </div>
            </div>
            <div class="hint" id="dashMonthLabel">M√™s: ‚Äî</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">
    <div>‚ö†Ô∏è</div>
    <div>
      <b id="toastTitle">Aviso</b>
      <div class="small" id="toastMsg"></div>
    </div>
  </div>

  <!-- Modal confirma√ß√£o EXCLUIR -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <h3>Confirmar exclus√£o</h3>
        <button class="btn btn-ghost btn-icon" id="btnModalClose" type="button">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody">Tem certeza?</div>
      <div class="modalFoot">
        <button class="btn btn-ghost" id="btnCancelar" type="button">Cancelar</button>
        <button class="btn btn-danger" id="btnConfirmar" type="button">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Modal EDITAR -->
  <div class="modalOverlay" id="editOverlay">
    <div class="modal">
      <div class="modalHead">
        <h3>Editar lan√ßamento</h3>
        <button class="btn btn-ghost btn-icon" id="btnEditClose" type="button">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>Data (DD/MM/AAAA)</label>
            <input id="editData" />
          </div>
          <div class="field">
            <label>Tipo</label>
            <select id="editTipo">
              <option value="entrada">Entrada</option>
              <option value="saida">Sa√≠da</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Valor (R$)</label>
            <input id="editValor" type="number" />
          </div>
          <div class="field">
            <label>Categoria</label>
            <input id="editCategoria" placeholder="Ex: Vendas, Mercado..." />
          </div>
        </div>
        <div class="field">
          <label>Descri√ß√£o</label>
          <input id="editDescricao" />
        </div>
        <div class="hint">Ao salvar, o m√™s (MM/AAAA) √© recalculado pela data.</div>
      </div>
      <div class="modalFoot">
        <button class="btn btn-ghost" id="btnEditCancelar" type="button">Cancelar</button>
        <button class="btn btn-primary" id="btnEditSalvar" type="button">Salvar altera√ß√µes</button>
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://ssnabfzwfvcmwkgibvec.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbmFiZnp3ZnZjbXdrZ2lidmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTE1MjcsImV4cCI6MjA4NTYyNzUyN30.s02EFB4FRopxB7Ak7zWUSkINcGY5ESRn7SLbDXn0Wbo";

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // UI refs
  const loginBox = document.getElementById("loginBox");
  const financasBox = document.getElementById("financasBox");
  const metasBox = document.getElementById("metasBox");
  const dashboardBox = document.getElementById("dashboardBox");
  const tabs = document.getElementById("tabs");
  const tabFin = document.getElementById("tabFin");
  const tabMeta = document.getElementById("tabMeta");
  const tabDash = document.getElementById("tabDash");
  const pillEmail = document.getElementById("pillEmail");
  const btnSair = document.getElementById("btnSair");
  const btnLogin = document.getElementById("btnLogin");

  const mesSelect = document.getElementById("mesSelect");
  const filtroCategoriaEl = document.getElementById("filtroCategoria");
  const tipoEl = document.getElementById("tipo");
  const dataEl = document.getElementById("data");
  const valorEl = document.getElementById("valor");
  const categoriaEl = document.getElementById("categoria");
  const descricaoEl = document.getElementById("descricao");
  const btnSalvar = document.getElementById("btnSalvar");
  const btnExportar = document.getElementById("btnExportar");
  const listaEl = document.getElementById("lista");
  const buscaEl = document.getElementById("busca");
  const buscaInfo = document.getElementById("buscaInfo");

  const kpiEntradas = document.getElementById("kpiEntradas");
  const kpiSaidas = document.getElementById("kpiSaidas");
  const kpiSaldo = document.getElementById("kpiSaldo");
  const kpiQtd = document.getElementById("kpiQtd");

  const catResumoEl = document.getElementById("catResumo");
  const catHint = document.getElementById("catHint");

  const metaMesEl = document.getElementById("metaMes");
  const metaValorEl = document.getElementById("metaValor");
  const btnSalvarMeta = document.getElementById("btnSalvarMeta");

  const metaKpi = document.getElementById("metaKpi");
  const ganheiKpi = document.getElementById("ganheiKpi");
  const faltaKpi = document.getElementById("faltaKpi");
  const mediaDiaKpi = document.getElementById("mediaDiaKpi");
  const bar = document.getElementById("bar");
  const progressText = document.getElementById("progressText");

  const toast = document.getElementById("toast");
  const toastTitle = document.getElementById("toastTitle");
  const toastMsg = document.getElementById("toastMsg");
  let toastTimer = null;

  // Modal excluir
  const modalOverlay = document.getElementById("modalOverlay");
  const modalBody = document.getElementById("modalBody");
  const btnModalClose = document.getElementById("btnModalClose");
  const btnCancelar = document.getElementById("btnCancelar");
  const btnConfirmar = document.getElementById("btnConfirmar");

  // Modal editar
  const editOverlay = document.getElementById("editOverlay");
  const btnEditClose = document.getElementById("btnEditClose");
  const btnEditCancelar = document.getElementById("btnEditCancelar");
  const btnEditSalvar = document.getElementById("btnEditSalvar");
  const editDataEl = document.getElementById("editData");
  const editTipoEl = document.getElementById("editTipo");
  const editValorEl = document.getElementById("editValor");
  const editCategoriaEl = document.getElementById("editCategoria");
  const editDescricaoEl = document.getElementById("editDescricao");

  // Dashboard refs
  const dashHint1 = document.getElementById("dashHint1");
  const dashHint2 = document.getElementById("dashHint2");
  const topCatsBox = document.getElementById("topCatsBox");
  const dashEntradas = document.getElementById("dashEntradas");
  const dashSaidas = document.getElementById("dashSaidas");
  const dashSaldo = document.getElementById("dashSaldo");
  const dashQtd = document.getElementById("dashQtd");
  const dashMonthLabel = document.getElementById("dashMonthLabel");

  let currentUser = null;
  let currentMonth = null;
  let pendingDelete = null;
  let currentFiltroCategoria = "Todas";
  let currentSearch = "";

  // cache m√™s atual
  let lastFinCache = null;

  // charts
  let chartBars = null;
  let chartSaldo = null;

  // edi√ß√£o
  let editingItem = null;

  function showToast(title, msg){
    toastTitle.textContent = title;
    toastMsg.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 6500);
  }

  function brl(n){
    return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(Number(n || 0));
  }
  function escapeHtml(str){
    return (str || "").toString().replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function monthKeyFromDateObj(d){ return `${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
  function getDefaultMonth(){ return monthKeyFromDateObj(new Date()); }
  function getTodayBR(){
    const d = new Date();
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  }
  function parseBRDateToISO(br){
    const v = (br || "").trim();
    const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (!m) return null;
    const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
    if (mm < 1 || mm > 12) return null;
    const dim = new Date(yyyy, mm, 0).getDate();
    if (dd < 1 || dd > dim) return null;
    return `${yyyy}-${pad2(mm)}-${pad2(dd)}`;
  }
  function formatISOToBR(iso){
    const m = (iso || "").match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (!m) return "";
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
  function parseMonthKey(mk){
    const m = (mk || "").trim().match(/^(\d{2})\/(\d{4})$/);
    if (!m) return null;
    const mm = Number(m[1]), yyyy = Number(m[2]);
    if (mm < 1 || mm > 12) return null;
    return { mm, yyyy };
  }
  function monthStartEndISO(monthKey){
    const p = parseMonthKey(monthKey);
    if (!p) return null;
    const start = `${p.yyyy}-${pad2(p.mm)}-01`;
    const endDay = new Date(p.yyyy, p.mm, 0).getDate();
    const end = `${p.yyyy}-${pad2(p.mm)}-${pad2(endDay)}`;
    return { start, end };
  }
  function remainingDays(mm, yyyy){
    const now = new Date();
    const isCurrent = (now.getFullYear() === yyyy && (now.getMonth()+1) === mm);
    const dim = new Date(yyyy, mm, 0).getDate();
    if (!isCurrent) return dim;
    return Math.max(dim - now.getDate() + 1, 1);
  }
  function getLastNMonthKeys(n){
    const out = [];
    const now = new Date();
    for (let i = n-1; i >= 0; i--){
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      out.push(monthKeyFromDateObj(d));
    }
    return out;
  }

  function showLogin(){
    loginBox.classList.remove("hidden");
    tabs.classList.add("hidden");
    financasBox.classList.add("hidden");
    metasBox.classList.add("hidden");
    dashboardBox.classList.add("hidden");
    btnSair.classList.add("hidden");
    pillEmail.textContent = "N√£o logado";
  }
  function showApp(email){
    loginBox.classList.add("hidden");
    tabs.classList.remove("hidden");
    btnSair.classList.remove("hidden");
    pillEmail.textContent = email || "Logado";
    forceShowFinancas();
  }
  function setActiveTab(active){
    for (const el of [tabFin, tabMeta, tabDash]) el.classList.remove("active");
    active.classList.add("active");
  }
  function forceShowFinancas(){
    setActiveTab(tabFin);
    financasBox.classList.remove("hidden");
    metasBox.classList.add("hidden");
    dashboardBox.classList.add("hidden");
  }
  function showMetas(){
    setActiveTab(tabMeta);
    metasBox.classList.remove("hidden");
    financasBox.classList.add("hidden");
    dashboardBox.classList.add("hidden");
  }
  function showDashboard(){
    setActiveTab(tabDash);
    dashboardBox.classList.remove("hidden");
    financasBox.classList.add("hidden");
    metasBox.classList.add("hidden");
  }

  function openModalDelete(item){
    pendingDelete = item;
    const tipoTxt = item.valor >= 0 ? "Entrada" : "Sa√≠da";
    modalBody.innerHTML = `
      <div>Voc√™ quer excluir este lan√ßamento?</div>
      <div style="height:10px"></div>
      <div class="mono" style="opacity:.9">
        ${escapeHtml(tipoTxt)} ‚Ä¢ ${escapeHtml(formatISOToBR(item.dataISO))} ‚Ä¢ ${escapeHtml(item.mes || "")}
      </div>
      <div style="height:6px"></div>
      <div><b>${escapeHtml(item.descricao)}</b></div>
      <div style="height:6px"></div>
      <div style="opacity:.85">Categoria: <b>${escapeHtml(item.categoria || "Outros")}</b></div>
      <div style="height:6px"></div>
      <div style="color:${item.valor>=0?'#22c55e':'#ff8080'};font-weight:900">${brl(item.valor)}</div>
      <div style="height:10px"></div>
      <div style="opacity:.75">Essa a√ß√£o n√£o pode ser desfeita.</div>
    `;
    modalOverlay.classList.add("show");
  }
  function closeModalDelete(){
    modalOverlay.classList.remove("show");
    pendingDelete = null;
  }

  function openEditModal(item){
    editingItem = item;

    editDataEl.value = formatISOToBR(item.dataISO);
    editTipoEl.value = item.valor >= 0 ? "entrada" : "saida";
    editValorEl.value = Math.abs(Number(item.valor || 0));
    editCategoriaEl.value = item.categoria || "Outros";
    editDescricaoEl.value = item.descricao || "";

    editOverlay.classList.add("show");
  }
  function closeEditModal(){
    editOverlay.classList.remove("show");
    editingItem = null;
  }

  async function captureTokenIfPresent(){
    if (window.location.hash && window.location.hash.includes("access_token=")) {
      await supa.auth.getSessionFromUrl({ storeSession: true });
      history.replaceState({}, document.title, "/");
    }
  }

  function fillMonthDropdown(months, selected){
    const unique = Array.from(new Set(months.filter(Boolean)));
    unique.sort((a,b) => {
      const pa = parseMonthKey(a), pb = parseMonthKey(b);
      if (!pa || !pb) return 0;
      if (pa.yyyy !== pb.yyyy) return pb.yyyy - pa.yyyy;
      return pb.mm - pa.mm;
    });
    mesSelect.innerHTML = "";
    for (const mk of unique){
      const opt = document.createElement("option");
      opt.value = mk;
      opt.textContent = mk;
      mesSelect.appendChild(opt);
    }
    mesSelect.value = selected;
    if (mesSelect.value !== selected && unique.length) mesSelect.value = unique[0];
  }

  function fillCategoriaFilter(categorias, selected){
    const unique = Array.from(new Set(categorias.filter(Boolean)));
    unique.sort((a,b) => a.localeCompare(b, "pt-BR"));

    filtroCategoriaEl.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "Todas";
    optAll.textContent = "Todas";
    filtroCategoriaEl.appendChild(optAll);

    for (const c of unique){
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      filtroCategoriaEl.appendChild(opt);
    }
    filtroCategoriaEl.value = selected || "Todas";
  }

  async function fetchMonthsFromRegistros(userId){
    const { data, error } = await supa
      .from("registros")
      .select("mes")
      .eq("user_id", userId)
      .order("mes", { ascending: false })
      .limit(5000);
    if (error) throw error;
    return (data || []).map(r => r.mes).filter(Boolean);
  }

  async function fetchRegistrosByMonth(userId, monthKey){
    const range = monthStartEndISO(monthKey);
    if (!range) throw new Error("M√™s inv√°lido.");
    const { data, error } = await supa
      .from("registros")
      .select("id, descricao, valor, data, mes, categoria")
      .eq("user_id", userId)
      .gte("data", range.start)
      .lte("data", range.end)
      .order("data", { ascending: false });
    if (error) throw error;

    const rows = (data || []).map(r => {
      const v = Number(r.valor || 0);
      const tipo = v >= 0 ? "entrada" : "saida";
      return ({
        id: r.id,
        descricao: r.descricao ?? "",
        valor: v,
        dataISO: r.data,
        mes: r.mes,
        categoria: r.categoria || "Outros",
        tipo
      });
    });

    let entradas=0, saidas=0, saldo=0;
    for (const r of rows){
      saldo += r.valor;
      if (r.valor >= 0) entradas += r.valor;
      else saidas += Math.abs(r.valor);
    }

    const categorias = rows.map(r => r.categoria || "Outros");
    return { rows, entradas, saidas, saldo, categorias };
  }

  function buildResumoCategorias(rows){
    const map = new Map();
    for (const r of rows){
      const cat = r.categoria || "Outros";
      if (!map.has(cat)) map.set(cat, { in: 0, out: 0 });
      const obj = map.get(cat);
      if (r.valor >= 0) obj.in += r.valor;
      else obj.out += Math.abs(r.valor);
    }

    const arr = Array.from(map.entries()).map(([cat, v]) => ({ cat, in: v.in, out: v.out }));
    arr.sort((a,b) => (b.in - a.in) || (b.out - a.out) || a.cat.localeCompare(b.cat,"pt-BR"));

    if (!arr.length){
      catResumoEl.innerHTML = `<div class="empty">Sem dados ainda.</div>`;
      return;
    }

    catResumoEl.innerHTML = arr.map(x => `
      <div class="catRow">
        <div class="catName">${escapeHtml(x.cat)}</div>
        <div class="catNums">
          <span class="chip in">Entradas: ${brl(x.in)}</span>
          <span class="chip out">Sa√≠das: ${brl(x.out)}</span>
        </div>
      </div>
    `).join("");
  }

  function renderFinancas(fin){
    lastFinCache = fin;

    const { rows, entradas, saidas, saldo } = fin;

    kpiEntradas.textContent = brl(entradas);
    kpiSaidas.textContent = brl(saidas);
    kpiSaldo.textContent = brl(saldo);
    kpiSaldo.className = "v " + (saldo >= 0 ? "green" : "red");
    kpiQtd.textContent = String(rows.length);

    catHint.textContent = `M√™s: ${currentMonth}`;
    buildResumoCategorias(rows);

    let filtered = rows;

    // filtro categoria
    if (currentFiltroCategoria && currentFiltroCategoria !== "Todas"){
      filtered = filtered.filter(r => (r.categoria || "Outros") === currentFiltroCategoria);
    }

    // busca descri√ß√£o
    const q = (currentSearch || "").trim().toLowerCase();
    if (q){
      filtered = filtered.filter(r => (r.descricao || "").toLowerCase().includes(q));
      buscaInfo.textContent = `Filtrando: "${currentSearch}" ‚Ä¢ ${filtered.length} itens`;
    } else {
      buscaInfo.textContent = "Mostrando tudo";
    }

    if (!filtered.length){
      listaEl.innerHTML = `<div class="empty">Nenhum registro para este filtro.</div>`;
      return;
    }

    listaEl.innerHTML = filtered.map(r => {
      const cls = r.valor >= 0 ? "pos" : "neg";
      const bCls = r.tipo === "entrada" ? "in" : "out";
      const bTxt = r.tipo === "entrada" ? "Entrada" : "Sa√≠da";
      const catTxt = r.categoria || "Outros";
      return `
        <div class="item">
          <div class="leftcol">
            <div class="desc">${escapeHtml(r.descricao)}</div>
            <div class="meta">
              <span class="badge ${bCls}">${bTxt}</span>
              <span class="badge cat">${escapeHtml(catTxt)}</span>
              <span class="badge">${escapeHtml(formatISOToBR(r.dataISO))}</span>
            </div>
          </div>
          <div class="rightcol">
            <div class="amount ${cls}">${brl(r.valor)}</div>
            <button class="btn btn-icon btn-icon-edit" type="button"
              title="Editar"
              data-edit="1"
              data-id="${escapeHtml(String(r.id))}"
              data-desc="${escapeHtml(r.descricao)}"
              data-valor="${escapeHtml(String(r.valor))}"
              data-data="${escapeHtml(String(r.dataISO))}"
              data-mes="${escapeHtml(String(r.mes || ""))}"
              data-cat="${escapeHtml(String(r.categoria || "Outros"))}"
            >‚úèÔ∏è</button>
            <button class="btn btn-icon btn-icon-danger" type="button"
              title="Excluir"
              data-del="1"
              data-id="${escapeHtml(String(r.id))}"
              data-desc="${escapeHtml(r.descricao)}"
              data-valor="${escapeHtml(String(r.valor))}"
              data-data="${escapeHtml(String(r.dataISO))}"
              data-mes="${escapeHtml(String(r.mes || ""))}"
              data-cat="${escapeHtml(String(r.categoria || "Outros"))}"
            >üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join("");
  }

  async function getMeta(userId, mes){
    const { data, error } = await supa
      .from("config")
      .select("meta")
      .eq("user_id", userId)
      .eq("mes", mes)
      .maybeSingle();
    if (error) throw error;
    return Number(data?.meta || 0);
  }

  async function upsertMeta(userId, mes, meta){
    const { error } = await supa
      .from("config")
      .upsert({ user_id: userId, mes, meta }, { onConflict: "user_id,mes" });
    if (error) throw error;
  }

  async function atualizarMetasUI(mes){
    const meta = await getMeta(currentUser.id, mes);
    const fin = lastFinCache && currentMonth === mes ? lastFinCache : await fetchRegistrosByMonth(currentUser.id, mes);
    const entradasMes = fin.entradas;

    metaKpi.textContent = brl(meta);
    ganheiKpi.textContent = brl(entradasMes);

    const falta = Math.max(meta - entradasMes, 0);
    faltaKpi.textContent = brl(falta);

    const p = parseMonthKey(mes);
    const dias = p ? remainingDays(p.mm, p.yyyy) : 30;
    const mediaDia = dias > 0 ? (falta / dias) : falta;
    mediaDiaKpi.textContent = brl(mediaDia);

    const perc = meta > 0 ? (entradasMes / meta) * 100 : 0;
    bar.style.width = Math.max(0, Math.min(perc, 100)) + "%";
    progressText.textContent = `${(Math.min(perc, 100)).toFixed(1)}% da meta ‚Ä¢ ${dias} dias`;
  }

  async function deleteRegistroById(id){
    const { error } = await supa
      .from("registros")
      .delete()
      .eq("id", id)
      .eq("user_id", currentUser.id);
    if (error) throw error;
  }

  async function updateRegistroById(id, patch){
    const { error } = await supa
      .from("registros")
      .update(patch)
      .eq("id", id)
      .eq("user_id", currentUser.id);
    if (error) throw error;
  }

  function makeCSV(rows){
    const header = ["Data","Tipo","Categoria","Descri√ß√£o","Valor"];
    const lines = [header];
    for (const r of rows){
      const tipo = r.valor >= 0 ? "Entrada" : "Sa√≠da";
      const cat = r.categoria || "Outros";
      const dataBR = formatISOToBR(r.dataISO);
      const valor = r.valor;
      const desc = (r.descricao || "").replace(/\s+/g, " ").trim();

      lines.push([dataBR, tipo, cat, desc, String(valor)].map(v => {
        const s = String(v ?? "");
        if (/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }));
    }
    return lines.map(l => l.join(";")).join("\n");
  }

  function downloadCSV(content, filename){
    const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- DASHBOARD ----------
  function updateDashResumoFromCurrentMonth(){
    const fin = lastFinCache;
    if (!fin){ return; }

    dashEntradas.textContent = brl(fin.entradas);
    dashSaidas.textContent = brl(fin.saidas);
    dashSaldo.textContent = brl(fin.saldo);
    dashSaldo.className = "v " + (fin.saldo >= 0 ? "green" : "red");
    dashQtd.textContent = String(fin.rows.length);
    dashMonthLabel.textContent = `M√™s: ${currentMonth || "-"}`;

    const map = new Map();
    for (const r of fin.rows){
      const cat = r.categoria || "Outros";
      if (!map.has(cat)) map.set(cat, { in: 0, out: 0 });
      const obj = map.get(cat);
      if (r.valor >= 0) obj.in += r.valor;
      else obj.out += Math.abs(r.valor);
    }
    const arr = Array.from(map.entries()).map(([cat, v]) => ({ cat, in: v.in, out: v.out }));
    arr.sort((a,b) => (b.out - a.out) || (b.in - a.in) || a.cat.localeCompare(b.cat,"pt-BR"));

    if (!arr.length){
      topCatsBox.innerHTML = `<div class="empty">Sem dados ainda.</div>`;
      return;
    }

    const top = arr.slice(0, 5);
    topCatsBox.innerHTML = top.map(x => `
      <div class="topItem">
        <div class="topLeft">
          <div class="topTitle">${escapeHtml(x.cat)}</div>
          <div class="topSub">Entradas: ${brl(x.in)} ‚Ä¢ Sa√≠das: ${brl(x.out)}</div>
        </div>
        <div class="topVal">${brl(x.out > 0 ? -x.out : x.in)}</div>
      </div>
    `).join("");
  }

  async function fetchRegistrosForDashboardLastNMonths(userId, n){
    const keys = getLastNMonthKeys(n);
    const first = keys[0];
    const last = keys[keys.length - 1];
    const r1 = monthStartEndISO(first);
    const r2 = monthStartEndISO(last);
    if (!r1 || !r2) throw new Error("Range inv√°lido dashboard.");

    const { data, error } = await supa
      .from("registros")
      .select("valor, data")
      .eq("user_id", userId)
      .gte("data", r1.start)
      .lte("data", r2.end);

    if (error) throw error;

    const init = {};
    for (const k of keys) init[k] = { entradas: 0, saidas: 0, saldo: 0 };

    for (const row of (data || [])){
      const iso = row.data;
      const m = (iso || "").match(/^(\d{4})-(\d{2})-\d{2}$/);
      if (!m) continue;
      const mk = `${m[2]}/${m[1]}`;
      if (!init[mk]) continue;

      const v = Number(row.valor || 0);
      init[mk].saldo += v;
      if (v >= 0) init[mk].entradas += v;
      else init[mk].saidas += Math.abs(v);
    }

    return { keys, byMonth: init };
  }

  function makeChartCommonOptions(){
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "rgba(226,232,240,.85)" } },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${brl(ctx.raw)}`
          }
        }
      },
      scales: {
        x: { ticks: { color: "rgba(226,232,240,.70)" }, grid: { color: "rgba(148,163,184,.10)" } },
        y: {
          ticks: {
            color: "rgba(226,232,240,.70)",
            callback: (v) => brl(v)
          },
          grid: { color: "rgba(148,163,184,.10)" }
        }
      }
    };
  }

  async function refreshDashboard(){
    if (!currentUser) return;

    try{
      dashHint1.textContent = "Carregando‚Ä¶";
      dashHint2.textContent = "Carregando‚Ä¶";

      const { keys, byMonth } = await fetchRegistrosForDashboardLastNMonths(currentUser.id, 6);

      const entradasArr = keys.map(k => byMonth[k].entradas);
      const saidasArr = keys.map(k => byMonth[k].saidas);
      const saldoArr = keys.map(k => byMonth[k].saldo);

      const ctx1 = document.getElementById("chartBars");
      const ctx2 = document.getElementById("chartSaldo");

      if (!chartBars){
        chartBars = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: keys,
            datasets: [
              { label: "Entradas", data: entradasArr },
              { label: "Sa√≠das", data: saidasArr }
            ]
          },
          options: makeChartCommonOptions()
        });
      } else {
        chartBars.data.labels = keys;
        chartBars.data.datasets[0].data = entradasArr;
        chartBars.data.datasets[1].data = saidasArr;
        chartBars.update();
      }

      if (!chartSaldo){
        chartSaldo = new Chart(ctx2, {
          type: "line",
          data: {
            labels: keys,
            datasets: [
              { label: "Saldo", data: saldoArr, tension: 0.3 }
            ]
          },
          options: makeChartCommonOptions()
        });
      } else {
        chartSaldo.data.labels = keys;
        chartSaldo.data.datasets[0].data = saldoArr;
        chartSaldo.update();
      }

      dashHint1.textContent = `Atualizado ‚Ä¢ ${keys[0]} ‚Üí ${keys[keys.length-1]}`;
      dashHint2.textContent = `Atualizado ‚Ä¢ ${keys[0]} ‚Üí ${keys[keys.length-1]}`;
      updateDashResumoFromCurrentMonth();

    }catch(e){
      showToast("Dashboard", e.message || String(e));
      dashHint1.textContent = "N√£o foi poss√≠vel carregar.";
      dashHint2.textContent = "N√£o foi poss√≠vel carregar.";
    }
  }
  // ---------- /DASHBOARD ----------

  async function refreshUI(){
    const { data } = await supa.auth.getSession();
    const session = data.session;

    if (!session){
      currentUser = null;
      showLogin();
      return;
    }

    currentUser = session.user;
    showApp(session.user.email);

    if (!dataEl.value) dataEl.value = getTodayBR();

    let months = [getDefaultMonth()];
    try{
      months = months.concat(await fetchMonthsFromRegistros(currentUser.id));
    }catch(e){
      showToast("Aviso", "N√£o consegui carregar meses ainda.");
    }

    const desired = currentMonth || getDefaultMonth();
    fillMonthDropdown(months, desired);
    currentMonth = mesSelect.value || getDefaultMonth();
    metaMesEl.value = currentMonth;

    try{
      const fin = await fetchRegistrosByMonth(currentUser.id, currentMonth);
      fillCategoriaFilter(fin.categorias.length ? fin.categorias : ["Vendas","Outros"], currentFiltroCategoria);
      renderFinancas(fin);
      updateDashResumoFromCurrentMonth();
    }catch(e){
      showToast("Finan√ßas", e.message || String(e));
    }

    try{
      await atualizarMetasUI(currentMonth);
    }catch(e){}

    if (document.body.contains(dashboardBox) && !dashboardBox.classList.contains("hidden")){
      await refreshDashboard();
    }
  }

  // Tabs
  tabFin.addEventListener("click", () => forceShowFinancas());
  tabMeta.addEventListener("click", async () => {
    showMetas();
    if (currentUser){
      try{ await atualizarMetasUI(currentMonth); }catch(e){
        showToast("Metas", e.message || String(e));
      }
    }
  });
  tabDash.addEventListener("click", async () => {
    showDashboard();
    await refreshDashboard();
  });

  // Login
  btnLogin.addEventListener("click", async () => {
    const { error } = await supa.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.origin }
    });
    if (error) showToast("Login", error.message);
  });

  // Troca m√™s
  mesSelect.addEventListener("change", async () => {
    if (!currentUser) return;
    currentMonth = mesSelect.value;
    metaMesEl.value = currentMonth;
    await refreshUI();
  });

  // Troca filtro categoria
  filtroCategoriaEl.addEventListener("change", async () => {
    currentFiltroCategoria = filtroCategoriaEl.value;
    await refreshUI();
  });

  // Busca
  buscaEl.addEventListener("input", async () => {
    currentSearch = buscaEl.value;
    if (lastFinCache) renderFinancas(lastFinCache);
  });

  // Salvar lan√ßamento
  btnSalvar.addEventListener("click", async () => {
    if (!currentUser){ showLogin(); return; }

    const tipo = tipoEl.value;
    const dataBR = dataEl.value.trim();
    const dataISO = parseBRDateToISO(dataBR);
    const valorDigitado = Number(valorEl.value);
    const descricao = descricaoEl.value.trim();
    const categoria = (categoriaEl.value || "Outros").trim();

    if (!dataISO){ showToast("Data inv√°lida", "Use DD/MM/AAAA."); return; }
    if (!descricao){ showToast("Descri√ß√£o", "Preencha a descri√ß√£o."); return; }
    if (Number.isNaN(valorDigitado) || valorDigitado <= 0){
      showToast("Valor", "Digite um valor positivo (ex: 100).");
      return;
    }

    const valorFinal = (tipo === "saida") ? -Math.abs(valorDigitado) : Math.abs(valorDigitado);
    const d = new Date(dataISO + "T00:00:00");
    const mesAuto = monthKeyFromDateObj(d);

    const { error } = await supa.from("registros").insert({
      user_id: currentUser.id,
      descricao,
      valor: valorFinal,
      data: dataISO,
      mes: mesAuto,
      categoria
    });

    if (error){ showToast("N√£o salvou (registros)", error.message); return; }

    descricaoEl.value = "";
    valorEl.value = "";
    currentMonth = mesAuto;

    await refreshUI();
    await refreshDashboard();
  });

  // Exportar CSV (respeita categoria + busca)
  btnExportar.addEventListener("click", () => {
    if (!lastFinCache || !lastFinCache.rows) {
      showToast("Exportar", "Sem dados carregados para exportar.");
      return;
    }

    let rows = lastFinCache.rows;

    if (currentFiltroCategoria && currentFiltroCategoria !== "Todas"){
      rows = rows.filter(r => (r.categoria || "Outros") === currentFiltroCategoria);
    }

    const q = (currentSearch || "").trim().toLowerCase();
    if (q){
      rows = rows.filter(r => (r.descricao || "").toLowerCase().includes(q));
    }

    if (!rows.length){
      showToast("Exportar", "N√£o h√° registros para exportar neste filtro/busca.");
      return;
    }

    const csv = makeCSV(rows);
    const safeMonth = (currentMonth || "mes").replace("/", "-");
    const safeCat = (currentFiltroCategoria || "Todas").replace(/[^\w√Ä-√ø-]+/g, "_");
    const safeSearch = (q ? ("busca_" + q) : "tudo").replace(/[^\w√Ä-√ø-]+/g, "_");
    const filename = `controle-premium_${safeMonth}_${safeCat}_${safeSearch}.csv`;

    downloadCSV(csv, filename);
    showToast("Exportado ‚úÖ", `Arquivo gerado: ${filename}`);
  });

  // Salvar meta
  btnSalvarMeta.addEventListener("click", async () => {
    if (!currentUser){ showLogin(); return; }

    const mes = metaMesEl.value.trim();
    const meta = Number(metaValorEl.value);

    if (!parseMonthKey(mes)){ showToast("M√™s inv√°lido", "Use MM/AAAA."); return; }
    if (Number.isNaN(meta) || meta < 0){ showToast("Meta inv√°lida", "Meta >= 0"); return; }

    try{
      await upsertMeta(currentUser.id, mes, meta);
      await atualizarMetasUI(mes);
      showToast("Meta salva ‚úÖ", "Meta salva no Supabase.");
    }catch(e){
      showToast("Meta", e.message || String(e));
    }
  });

  // Sair
  btnSair.addEventListener("click", async () => {
    await supa.auth.signOut();
    location.href = "/";
  });

  // Clique na lista (editar/excluir)
  listaEl.addEventListener("click", (e) => {
    const btnDel = e.target.closest("button[data-del='1']");
    const btnEdit = e.target.closest("button[data-edit='1']");

    if (btnEdit){
      const item = {
        id: btnEdit.getAttribute("data-id"),
        descricao: btnEdit.getAttribute("data-desc"),
        valor: Number(btnEdit.getAttribute("data-valor")),
        dataISO: btnEdit.getAttribute("data-data"),
        mes: btnEdit.getAttribute("data-mes"),
        categoria: btnEdit.getAttribute("data-cat")
      };
      openEditModal(item);
      return;
    }

    if (btnDel){
      const item = {
        id: btnDel.getAttribute("data-id"),
        descricao: btnDel.getAttribute("data-desc"),
        valor: Number(btnDel.getAttribute("data-valor")),
        dataISO: btnDel.getAttribute("data-data"),
        mes: btnDel.getAttribute("data-mes"),
        categoria: btnDel.getAttribute("data-cat")
      };
      openModalDelete(item);
      return;
    }
  });

  // Modal excluir
  btnModalClose.addEventListener("click", closeModalDelete);
  btnCancelar.addEventListener("click", closeModalDelete);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModalDelete();
  });

  btnConfirmar.addEventListener("click", async () => {
    if (!pendingDelete || !currentUser) return;

    try{
      await deleteRegistroById(pendingDelete.id);
      closeModalDelete();
      showToast("Exclu√≠do ‚úÖ", "Lan√ßamento removido com sucesso.");
      await refreshUI();
      await refreshDashboard();
    }catch(e){
      showToast("Erro ao excluir", e.message || String(e));
    }
  });

  // Modal editar
  btnEditClose.addEventListener("click", closeEditModal);
  btnEditCancelar.addEventListener("click", closeEditModal);
  editOverlay.addEventListener("click", (e) => {
    if (e.target === editOverlay) closeEditModal();
  });

  btnEditSalvar.addEventListener("click", async () => {
    if (!editingItem || !currentUser) return;

    const dataBR = (editDataEl.value || "").trim();
    const dataISO = parseBRDateToISO(dataBR);
    if (!dataISO){ showToast("Data inv√°lida", "Use DD/MM/AAAA."); return; }

    const tipo = editTipoEl.value;
    const valorDigitado = Number(editValorEl.value);
    if (Number.isNaN(valorDigitado) || valorDigitado <= 0){
      showToast("Valor", "Digite um valor positivo.");
      return;
    }

    const valorFinal = (tipo === "saida") ? -Math.abs(valorDigitado) : Math.abs(valorDigitado);
    const categoria = (editCategoriaEl.value || "Outros").trim() || "Outros";
    const descricao = (editDescricaoEl.value || "").trim();
    if (!descricao){ showToast("Descri√ß√£o", "Preencha a descri√ß√£o."); return; }

    const d = new Date(dataISO + "T00:00:00");
    const mesAuto = monthKeyFromDateObj(d);

    try{
      await updateRegistroById(editingItem.id, {
        data: dataISO,
        mes: mesAuto,
        valor: valorFinal,
        categoria,
        descricao
      });

      closeEditModal();
      showToast("Salvo ‚úÖ", "Lan√ßamento atualizado.");

      // se mudou de m√™s, mant√©m o seletor no novo m√™s
      currentMonth = mesAuto;
      await refreshUI();
      await refreshDashboard();
    }catch(e){
      showToast("Editar", e.message || String(e));
    }
  });

  // Init
  (async () => {
    await captureTokenIfPresent();
    if (!dataEl.value) dataEl.value = getTodayBR();
    currentFiltroCategoria = "Todas";
    currentSearch = "";
    await refreshUI();
    await refreshDashboard();
  })();

  supa.auth.onAuthStateChange(async () => {
    await refreshUI();
    await refreshDashboard();
  });
</script>
</body>
</html>
