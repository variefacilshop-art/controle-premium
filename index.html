<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}
header {
  background: #020617;
  padding: 20px;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
}
main {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
.card {
  background: #020617;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
}
button, input, select {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
}
button {
  background: #38bdf8;
  font-weight: bold;
  cursor: pointer;
}
button:hover { background: #0ea5e9; }
.hidden { display: none; }
.total {
  font-size: 22px;
  font-weight: bold;
  text-align: right;
  color: #22c55e;
}
.negativo { color: #ef4444; }
</style>
</head>

<body>

<header>ðŸ’Ž Controle Premium</header>

<main>

<div class="card" id="login">
  <h2>Entrar</h2>
  <button onclick="loginGoogle()">Entrar com Google</button>
</div>

<div id="app" class="hidden">

  <div class="card">
    <button onclick="logout()">Sair</button>
  </div>

  <div class="card">
    <h2>Novo LanÃ§amento</h2>

    <select id="tipo">
      <option value="entrada">Entrada</option>
      <option value="saida">SaÃ­da</option>
    </select>

    <input id="descricao" placeholder="DescriÃ§Ã£o">
    <input id="valor" type="number" placeholder="Valor (R$)">

    <button onclick="adicionar()">Adicionar</button>
  </div>

  <div class="card">
    <h2>RelatÃ³rio do MÃªs</h2>

    <select id="mesFiltro" onchange="carregar()"></select>

    <table width="100%">
      <thead>
        <tr>
          <th>DescriÃ§Ã£o</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="total" id="saldo">Saldo: R$ 0,00</div>
  </div>

</div>

</main>

<script>
const supabase = supabaseJs.createClient(
  "https://ssnabfzwfvcmwkgibvec.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbmFiZnp3ZnZjbXdrZ2lidmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTE1MjcsImV4cCI6MjA4NTYyNzUyN30.s02EFB4FRopxB7Ak7zWUSkINcGY5ESRn7SLbDXn0Wbo"
);

function loginGoogle() {
  supabase.auth.signInWithOAuth({ provider: "google" });
}

function logout() {
  supabase.auth.signOut();
  location.reload();
}

supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    carregarMeses();
    carregar();
  }
});

function mesAtual() {
  const d = new Date();
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
}

function formatar(v) {
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

async function carregarMeses() {
  const select = document.getElementById("mesFiltro");
  select.innerHTML = "";

  const { data } = await supabase
    .from("registros")
    .select("mes", { distinct: true });

  const meses = [...new Set((data||[]).map(r => r.mes))];
  if (!meses.includes(mesAtual())) meses.push(mesAtual());

  meses.sort().reverse().forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    select.appendChild(opt);
  });
}

async function carregar() {
  const mes = document.getElementById("mesFiltro").value || mesAtual();

  const { data } = await supabase
    .from("registros")
    .select("*")
    .eq("mes", mes)
    .order("id", { ascending: false });

  renderizar(data || []);
}

async function adicionar() {
  const tipo = document.getElementById("tipo").value;
  const descricao = document.getElementById("descricao").value;
  let valor = parseFloat(document.getElementById("valor").value);

  if (!descricao || isNaN(valor)) return;

  if (tipo === "saida") valor = -Math.abs(valor);

  await supabase.from("registros").insert({
    descricao,
    valor,
    mes: mesAtual()
  });

  descricao.value = "";
  valor.value = "";
  carregar();
}

function renderizar(lista) {
  const listaEl = document.getElementById("lista");
  listaEl.innerHTML = "";
  let saldo = 0;

  lista.forEach(r => {
    saldo += r.valor;
    listaEl.innerHTML += `
      <tr>
        <td>${r.descricao}</td>
        <td class="${r.valor < 0 ? "negativo":""}">
          ${formatar(r.valor)}
        </td>
      </tr>`;
  });

  document.getElementById("saldo").innerText =
    "Saldo: " + formatar(saldo);
}
</script>

</body>
</html>
