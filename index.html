<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Premium</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#020617;
  color:#e5e7eb;
}

.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
}

.card{
  background:#020617;
  border:1px solid #334155;
  padding:16px;
  border-radius:12px;
  margin-top:15px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

select,input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
}

button{
  cursor:pointer;
  background:#00c2ff;
  color:#001018;
  font-weight:bold;
  border:none;
}

.hidden{display:none}

.cat-list{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

.cat-item{
  border:1px solid #00c2ff;
  padding:4px 10px;
  border-radius:999px;
  cursor:pointer;
}

.cat-item span{
  margin-left:6px;
  color:#ef4444;
  cursor:pointer;
}

.chart-box{
  height:260px;
}
</style>
</head>
<body>

<div class="container">

<h2>Controle Premium</h2>

<!-- LOGIN -->
<div id="loginBox" class="card hidden">
  <button id="btnLogin">Entrar com Google</button>
</div>

<!-- APP -->
<div id="appBox" class="hidden">

<div class="card">
  <label>Categoria</label>

  <div class="row">
    <select id="categoriaSelect"></select>
    <button id="btnAddCategoria">+</button>
  </div>

  <div id="listaCategorias" class="cat-list"></div>
</div>

<div class="card">
  <h3>Metas</h3>

  <div class="row">
    <input id="metaMes" placeholder="MM/AAAA">
    <input id="metaValor" type="number" placeholder="Valor meta">
    <button id="salvarMeta">Salvar</button>
  </div>

  <p id="metaInfo"></p>

  <div class="row">
    <button id="verDia">Dia</button>
    <button id="verMes">Meses</button>
  </div>

  <div class="chart-box">
    <canvas id="graficoMeta"></canvas>
  </div>
</div>

</div>
<script>
const SUPABASE_URL = "https://ssnabfzwfvcmwkgibvec.supabase.co";
const SUPABASE_KEY = "COLE_SUA_ANON_KEY_AQUI";

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
});

let currentUser = null;
let categorias = [];
let grafico = null;

const loginBox = document.getElementById("loginBox");
const appBox = document.getElementById("appBox");

const btnLogin = document.getElementById("btnLogin");

const categoriaSelect = document.getElementById("categoriaSelect");
const listaCategorias = document.getElementById("listaCategorias");
const btnAddCategoria = document.getElementById("btnAddCategoria");

function showLogin(){
  loginBox.classList.remove("hidden");
  appBox.classList.add("hidden");
}

function showApp(){
  loginBox.classList.add("hidden");
  appBox.classList.remove("hidden");
}

// LOGIN GOOGLE
btnLogin.addEventListener("click", async () => {
  const { error } = await supa.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: window.location.href
    }
  });
  if (error) alert(error.message);
});

// ATUALIZA SESS√ÉO
supa.auth.onAuthStateChange(async () => {
  const { data } = await supa.auth.getSession();
  if (data.session) {
    currentUser = data.session.user;
    showApp();
    carregarCategorias();
  } else {
    showLogin();
  }
});

// INICIALIZA
(async () => {
  const { data } = await supa.auth.getSession();
  if (data.session) {
    currentUser = data.session.user;
    showApp();
    carregarCategorias();
  } else {
    showLogin();
  }
})();


// =========================
// CATEGORIAS
// =========================

async function carregarCategorias(){
  const { data } = await supa
    .from("categorias")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("nome");

  categorias = data || [];
  renderCategorias();
}

function renderCategorias(){
  categoriaSelect.innerHTML = "";
  listaCategorias.innerHTML = "";

  categorias.forEach(cat=>{
    const opt = document.createElement("option");
    opt.value = cat.nome;
    opt.textContent = cat.nome;
    categoriaSelect.appendChild(opt);

    const div = document.createElement("div");
    div.className = "cat-item";
    div.innerHTML = `${cat.nome} <span data-id="${cat.id}">‚úï</span>`;
    listaCategorias.appendChild(div);
  });
}

// adicionar categoria
btnAddCategoria.onclick = async ()=>{
  const nome = prompt("Nome da categoria:");
  if(!nome) return;

  await supa.from("categorias").insert({
    user_id: currentUser.id,
    nome
  });

  carregarCategorias();
};

// excluir categoria
listaCategorias.onclick = async (e)=>{
  if(e.target.tagName === "SPAN"){
    const id = e.target.dataset.id;
    await supa.from("categorias").delete().eq("id", id);
    carregarCategorias();
  }
};
// =========================
// LAN√áAMENTOS (REGISTROS)
// =========================

const mesSelect = document.getElementById("mesSelect");
const tipoSelect = document.getElementById("tipoSelect");
const dataInput = document.getElementById("dataInput");
const valorInput = document.getElementById("valorInput");
const descricaoInput = document.getElementById("descricaoInput");
const btnSalvarLanc = document.getElementById("btnSalvarLanc");
const listaLanc = document.getElementById("listaLanc");

const btnSelAll = document.getElementById("btnSelAll");
const btnSelNone = document.getElementById("btnSelNone");
const btnExcluirSelecionados = document.getElementById("btnExcluirSelecionados");
const selecionadosInfo = document.getElementById("selecionadosInfo");

let lancamentosMes = [];
let selectedIds = new Set();

// helpers
function pad2(n){ return String(n).padStart(2,"0"); }
function monthKeyFromISO(iso){
  const m = String(iso||"").match(/^(\d{4})-(\d{2})-/);
  if(!m) return null;
  return `${m[2]}/${m[1]}`;
}
function todayBR(){
  const d = new Date();
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
}
function brToISO(br){
  const m = String(br||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yyyy = +m[3];
  if(mm < 1 || mm > 12) return null;
  const dim = new Date(yyyy, mm, 0).getDate();
  if(dd < 1 || dd > dim) return null;
  return `${yyyy}-${pad2(mm)}-${pad2(dd)}`;
}
function isoToBR(iso){
  const m = String(iso||"").match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(!m) return "";
  return `${m[3]}/${m[2]}/${m[1]}`;
}
function brl(n){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n||0));
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

// m√™s padr√£o
function getDefaultMonth(){
  const d = new Date();
  return `${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
}

// carrega meses existentes (pra dropdown)
async function carregarMeses(){
  const { data, error } = await supa
    .from("registros")
    .select("mes")
    .eq("user_id", currentUser.id)
    .order("mes", { ascending: false })
    .limit(5000);

  if(error) return;

  const meses = Array.from(new Set((data||[]).map(x => x.mes).filter(Boolean)));
  const base = getDefaultMonth();
  if(!meses.includes(base)) meses.unshift(base);

  mesSelect.innerHTML = "";
  meses.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    mesSelect.appendChild(opt);
  });

  if(!mesSelect.value) mesSelect.value = base;
}

// carrega lan√ßamentos do m√™s selecionado
async function carregarLancamentos(){
  const mk = mesSelect.value || getDefaultMonth();

  const p = mk.match(/^(\d{2})\/(\d{4})$/);
  if(!p) return;

  const mm = +p[1], yyyy = +p[2];
  const start = `${yyyy}-${pad2(mm)}-01`;
  const endDay = new Date(yyyy, mm, 0).getDate();
  const end = `${yyyy}-${pad2(mm)}-${pad2(endDay)}`;

  const { data, error } = await supa
    .from("registros")
    .select("id,descricao,valor,data,mes,categoria")
    .eq("user_id", currentUser.id)
    .gte("data", start)
    .lte("data", end)
    .order("data", { ascending: false });

  if(error){
    alert(error.message);
    return;
  }

  lancamentosMes = data || [];
  selectedIds = new Set();
  renderLancamentos();
  atualizarMetaUI();       // atualiza meta do m√™s certinho
  atualizarGraficoDia();   // gr√°fico dia a dia desse m√™s
}

function renderLancamentos(){
  if(!listaLanc) return;

  if(!lancamentosMes.length){
    listaLanc.innerHTML = `<div class="empty">Nenhum lan√ßamento neste m√™s.</div>`;
    atualizarSelecionadosUI();
    return;
  }

  listaLanc.innerHTML = lancamentosMes.map(r=>{
    const id = String(r.id);
    const sel = selectedIds.has(id);
    const valor = Number(r.valor||0);
    const tipoTxt = valor >= 0 ? "Entrada" : "Sa√≠da";

    return `
      <div class="lanc-item ${sel ? "selected" : ""}">
        <label class="lanc-check">
          <input type="checkbox" data-sel="1" data-id="${escapeHtml(id)}" ${sel?"checked":""}/>
        </label>

        <div class="lanc-main">
          <div class="lanc-desc">${escapeHtml(r.descricao || "")}</div>
          <div class="lanc-meta">
            <span class="badge">${escapeHtml(tipoTxt)}</span>
            <span class="badge">${escapeHtml(r.categoria || "Outros")}</span>
            <span class="badge">${escapeHtml(isoToBR(r.data))}</span>
          </div>
        </div>

        <div class="lanc-valor ${valor>=0?"pos":"neg"}">${brl(valor)}</div>

        <button class="btn-lixeira" data-del="1" data-id="${escapeHtml(id)}">üóëÔ∏è</button>
      </div>
    `;
  }).join("");

  atualizarSelecionadosUI();
}

function atualizarSelecionadosUI(){
  const n = selectedIds.size;
  if(selecionadosInfo) selecionadosInfo.textContent = `Selecionados: ${n}`;
  if(btnExcluirSelecionados) btnExcluirSelecionados.disabled = (n === 0);
}

// clique na lista (selecionar / excluir 1)
listaLanc.addEventListener("click", async (e)=>{
  const sel = e.target.closest("[data-sel]");
  if(sel){
    const id = String(sel.dataset.id || "");
    if(!id) return;
    if(sel.checked) selectedIds.add(id);
    else selectedIds.delete(id);

    const item = sel.closest(".lanc-item");
    if(item) item.classList.toggle("selected", sel.checked);

    atualizarSelecionadosUI();
    return;
  }

  const delBtn = e.target.closest("[data-del]");
  if(delBtn){
    const id = String(delBtn.dataset.id || "");
    if(!id) return;

    const ok = confirm("Excluir esse lan√ßamento?");
    if(!ok) return;

    const { error } = await supa
      .from("registros")
      .delete()
      .eq("id", id)
      .eq("user_id", currentUser.id);

    if(error) alert(error.message);
    await carregarLancamentos();
  }
});

// selecionar tudo / limpar
btnSelAll?.addEventListener("click", ()=>{
  (lancamentosMes||[]).forEach(r => selectedIds.add(String(r.id)));
  renderLancamentos();
});

btnSelNone?.addEventListener("click", ()=>{
  selectedIds = new Set();
  renderLancamentos();
});

// excluir selecionados
btnExcluirSelecionados?.addEventListener("click", async ()=>{
  const ids = Array.from(selectedIds);
  if(!ids.length) return;

  const ok = confirm(`Excluir ${ids.length} lan√ßamento(s) selecionado(s)?`);
  if(!ok) return;

  // delete em lote (evita limite)
  const chunk = 200;
  for(let i=0; i<ids.length; i+=chunk){
    const parte = ids.slice(i, i+chunk);
    const { error } = await supa
      .from("registros")
      .delete()
      .in("id", parte)
      .eq("user_id", currentUser.id);

    if(error){
      alert(error.message);
      break;
    }
  }

  await carregarLancamentos();
});

// salvar lan√ßamento
btnSalvarLanc?.addEventListener("click", async ()=>{
  if(!currentUser) return;

  const tipo = tipoSelect.value; // entrada/saida
  const dataISO = brToISO(dataInput.value);
  const valor = Number(valorInput.value);
  const desc = (descricaoInput.value||"").trim();
  const cat = (categoriaSelect.value||"Outros").trim() || "Outros";

  if(!dataISO){ alert("Data inv√°lida. Use DD/MM/AAAA"); return; }
  if(!desc){ alert("Digite a descri√ß√£o."); return; }
  if(!Number.isFinite(valor) || valor <= 0){ alert("Digite um valor positivo."); return; }

  const valorFinal = (tipo === "saida") ? -Math.abs(valor) : Math.abs(valor);
  const mes = monthKeyFromISO(dataISO);

  const { error } = await supa.from("registros").insert({
    user_id: currentUser.id,
    descricao: desc,
    valor: valorFinal,
    data: dataISO,
    mes,
    categoria: cat
  });

  if(error){ alert(error.message); return; }

  descricaoInput.value = "";
  valorInput.value = "";

  // muda o dropdown para o m√™s do lan√ßamento
  await carregarMeses();
  mesSelect.value = mes;
  await carregarLancamentos();
});


// =========================
// METAS POR M√äS
// =========================

const metaMesInput = document.getElementById("metaMes");
const metaValorInput = document.getElementById("metaValor");
const btnSalvarMeta = document.getElementById("btnSalvarMeta");

const metaKpi = document.getElementById("metaKpi");
const entradasKpi = document.getElementById("entradasKpi");
const faltaKpi = document.getElementById("faltaKpi");
const progressoTxt = document.getElementById("progressoTxt");
const progressoBar = document.getElementById("progressoBar");

async function getMeta(mes){
  const { data, error } = await supa
    .from("config")
    .select("meta")
    .eq("user_id", currentUser.id)
    .eq("mes", mes)
    .maybeSingle();

  if(error) return 0;
  return Number(data?.meta || 0);
}

async function setMeta(mes, meta){
  const { error } = await supa
    .from("config")
    .upsert({ user_id: currentUser.id, mes, meta }, { onConflict: "user_id,mes" });

  if(error) throw error;
}

function somaEntradasDoMes(){
  return (lancamentosMes||[])
    .filter(x => Number(x.valor||0) > 0)
    .reduce((acc,x)=> acc + Number(x.valor||0), 0);
}

async function atualizarMetaUI(){
  if(!currentUser) return;

  const mes = mesSelect.value || getDefaultMonth();
  if(metaMesInput) metaMesInput.value = mes;

  const meta = await getMeta(mes);
  if(metaValorInput) metaValorInput.value = meta ? String(meta) : "";

  const entradas = somaEntradasDoMes();
  const falta = Math.max(meta - entradas, 0);
  const perc = meta > 0 ? Math.min((entradas/meta)*100, 100) : 0;

  if(metaKpi) metaKpi.textContent = brl(meta);
  if(entradasKpi) entradasKpi.textContent = brl(entradas);
  if(faltaKpi) faltaKpi.textContent = brl(falta);
  if(progressoTxt) progressoTxt.textContent = `${perc.toFixed(1)}% da meta`;
  if(progressoBar) progressoBar.style.width = `${perc}%`;

  // tamb√©m atualiza o gr√°fico de meses
  atualizarGraficoMeses();
}

btnSalvarMeta?.addEventListener("click", async ()=>{
  const mes = (metaMesInput.value || "").trim();
  const meta = Number(metaValorInput.value || 0);

  if(!/^\d{2}\/\d{4}$/.test(mes)){ alert("Use MM/AAAA"); return; }
  if(!Number.isFinite(meta) || meta < 0){ alert("Meta inv√°lida"); return; }

  try{
    await setMeta(mes, meta);
    alert(`Meta salva para ${mes}!`);
    // se a pessoa salvou meta de outro m√™s, mant√©m
    await atualizarMetaUI();
  }catch(e){
    alert(e.message || String(e));
  }
});


// =========================
// GR√ÅFICOS (COLUNAS)
// 1) Dia a dia (m√™s atual)
// 2) Meses (√∫ltimos 12)
// =========================

const btnGrafDia = document.getElementById("btnGrafDia");
const btnGrafMeses = document.getElementById("btnGrafMeses");
const canvasGraf = document.getElementById("graficoColunas");

let modoGrafico = "dia"; // "dia" | "meses"

function destruirGrafico(){
  if(grafico){
    grafico.destroy();
    grafico = null;
  }
}

function montarGrafico(labels, values, titulo){
  destruirGrafico();
  if(!canvasGraf) return;

  grafico = new Chart(canvasGraf, {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: titulo, data: values }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx)=> brl(ctx.raw) } }
      },
      scales: {
        x: { ticks: { color: "rgba(226,232,240,.7)" }, grid: { color: "rgba(148,163,184,.10)" } },
        y: { ticks: { color: "rgba(226,232,240,.7)", callback: (v)=> brl(v) }, grid: { color: "rgba(148,163,184,.10)" } }
      }
    }
  });
}

// dia a dia = soma ENTRADAS por dia
function atualizarGraficoDia(){
  modoGrafico = "dia";
  const mk = mesSelect.value || getDefaultMonth();
  const p = mk.match(/^(\d{2})\/(\d{4})$/);
  if(!p) return;

  const mm = +p[1], yyyy = +p[2];
  const endDay = new Date(yyyy, mm, 0).getDate();
  const arr = Array.from({length:endDay}, ()=>0);

  (lancamentosMes||[]).forEach(r=>{
    const v = Number(r.valor||0);
    if(v <= 0) return; // s√≥ entradas
    const m = String(r.data||"").match(/^\d{4}-\d{2}-(\d{2})$/);
    if(!m) return;
    const dia = +m[1];
    if(dia>=1 && dia<=endDay) arr[dia-1] += v;
  });

  const labels = Array.from({length:endDay}, (_,i)=> String(i+1));
  montarGrafico(labels, arr, `Entradas por dia ‚Ä¢ ${mk}`);
}

// meses = soma ENTRADAS por m√™s (√∫ltimos 12)
async function atualizarGraficoMeses(){
  if(modoGrafico !== "meses") return;

  const keys = [];
  const now = new Date();
  for(let i=11;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    keys.push(`${pad2(d.getMonth()+1)}/${d.getFullYear()}`);
  }

  const first = keys[0].match(/^(\d{2})\/(\d{4})$/);
  const last = keys[keys.length-1].match(/^(\d{2})\/(\d{4})$/);
  if(!first || !last) return;

  const s1 = `${first[2]}-${first[1]}-01`;
  const endDay = new Date(+last[2], +last[1], 0).getDate();
  const s2 = `${last[2]}-${last[1]}-${pad2(endDay)}`;

  const { data, error } = await supa
    .from("registros")
    .select("valor,data")
    .eq("user_id", currentUser.id)
    .gte("data", s1)
    .lte("data", s2);

  if(error) return;

  const map = {};
  keys.forEach(k=> map[k]=0);

  (data||[]).forEach(r=>{
    const v = Number(r.valor||0);
    if(v <= 0) return; // s√≥ entradas
    const mk = monthKeyFromISO(r.data);
    if(map[mk] != null) map[mk] += v;
  });

  const values = keys.map(k=> map[k] || 0);
  montarGrafico(keys, values, "Entradas por m√™s (√∫ltimos 12)");
}

async function mostrarGraficoMeses(){
  modoGrafico = "meses";
  // monta j√°
  await atualizarGraficoMeses();
}

btnGrafDia?.addEventListener("click", ()=>{
  atualizarGraficoDia();
});
btnGrafMeses?.addEventListener("click", ()=>{
  mostrarGraficoMeses();
});

// quando muda o m√™s
mesSelect?.addEventListener("change", async ()=>{
  await carregarLancamentos();
  if(modoGrafico === "dia") atualizarGraficoDia();
  else atualizarGraficoMeses();
});

// =========================
// FINALIZA√á√ÉO AO ENTRAR NO APP
// =========================

async function iniciarAppDepoisDoLogin(){
  // preenche data
  if(dataInput && !dataInput.value) dataInput.value = todayBR();

  await carregarMeses();
  await carregarLancamentos();

  // padr√£o: gr√°fico dia
  atualizarGraficoDia();
}

// encaixa isso no fluxo do login (PARTE 2)
const _oldShowApp = showApp;
showApp = function(){
  _oldShowApp();
  iniciarAppDepoisDoLogin();
};
