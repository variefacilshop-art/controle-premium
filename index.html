<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg1:#020617; --bg2:#0b1225;
      --card: rgba(7, 12, 26, .78);
      --card2: rgba(7, 12, 26, .60);
      --stroke: rgba(148, 163, 184, .14);
      --text: #e5e7eb; --muted: rgba(226, 232, 240, .72);
      --cyan:#00c2ff; --cyan2:#33d2ff;
      --red:#ef4444; --green:#22c55e;
      --glow: 0 0 0 1px rgba(0,194,255,.18), 0 0 60px rgba(0,194,255,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(0,194,255,.16), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(99,102,241,.10), transparent 55%),
        radial-gradient(900px 700px at 40% 120%, rgba(34,197,94,.08), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex; justify-content:center;
      padding: 34px 18px;
    }
    .wrap{ width: 100%; max-width: 1120px; }
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 14px;}
    .brand{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px; border-radius: 999px;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: var(--glow);
    }
    .diamond{
      width: 34px; height: 34px; display:grid; place-items:center;
      border-radius: 12px;
      background: rgba(0,194,255,.12);
      border: 1px solid rgba(0,194,255,.25);
    }
    .brand h1{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .brand p{ margin:0; font-size: 12px; color: var(--muted); margin-top:2px; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px; border-radius: 999px;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size: 12px;
    }
    .btn{
      border:none; cursor:pointer; border-radius: 12px;
      padding: 10px 14px; font-weight: 900; font-size: 13px;
      transition: transform .06s ease, opacity .2s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(180deg, var(--cyan2), var(--cyan)); color:#001018; box-shadow: 0 16px 60px rgba(0,194,255,.20); }
    .btn-danger{ background: linear-gradient(180deg, #ff6b6b, var(--red)); color:#fff; box-shadow: 0 16px 60px rgba(239,68,68,.20); }
    .btn-ghost{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.14);
      color: rgba(226,232,240,.85);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-icon{ width: 36px; height: 36px; padding: 0; border-radius: 12px; font-weight: 900; }
    .btn-icon-danger{ background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.22); color: #ffb4b4; }
    .btn-icon-edit{ background: rgba(0,194,255,.10); border: 1px solid rgba(0,194,255,.22); color: rgba(200,245,255,.95); }

    .tabs{ display:flex; gap:10px; align-items:center; margin: 10px 0 16px; flex-wrap:wrap; }
    .tab{
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.45);
      color: var(--muted);
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .tab.active{
      background: rgba(0,194,255,.14);
      border-color: rgba(0,194,255,.25);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(0,194,255,.10);
    }

    .grid{ display:grid; grid-template-columns: 1fr 1.25fr; gap: 16px; }
    @media (max-width: 960px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .head{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card .head h2{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .card .head span{ color: var(--muted); font-size: 12px; }
    .card .body{ padding: 16px; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
    label{ font-size: 12px; color: var(--muted); }

    input, select{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.55);
      color: var(--text);
      outline: none;
    }
    select{ cursor:pointer; }
    input::placeholder{ color: rgba(226,232,240,.45); }
    input:focus, select:focus{ border-color: rgba(0,194,255,.35); box-shadow: 0 0 0 4px rgba(0,194,255,.10); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 520px){ .row{ grid-template-columns: 1fr; } }

    .hint{ font-size: 12px; color: rgba(226,232,240,.55); margin-top: 4px; }

    .summary{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kpi{
      background: var(--card2);
      border: 1px solid rgba(148,163,184,.10);
      border-radius: 16px;
      padding: 14px;
    }
    .kpi .k{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .v{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .kpi .v.green{ color: var(--green); }
    .kpi .v.red{ color: #ff8080; }

    .list{ max-height: 520px; overflow:auto; }
    .item{
      display:flex; justify-content:space-between; gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      align-items:center;
    }
    .item:last-child{ border-bottom:none; }
    .leftcol{ display:flex; flex-direction:column; gap:6px; min-width:0; flex:1; }
    .desc{ font-weight: 800; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{
      font-size: 11px; color: rgba(226,232,240,.75);
      padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.40);
    }
    .badge.in{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .badge.out{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); }
    .badge.cat{ border-color: rgba(0,194,255,.22); background: rgba(0,194,255,.08); }

    .rightcol{ display:flex; align-items:center; gap:10px; }
    .amount{ font-weight: 900; white-space: nowrap; font-size: 14px; }
    .amount.pos{ color: var(--green); }
    .amount.neg{ color: #ff8080; }
    .empty{ padding: 18px 16px; color: rgba(226,232,240,.60); font-size: 13px; }
    .hidden{ display:none !important; }

    .toast{
      position: fixed; left: 18px; bottom: 18px;
      max-width: 560px;
      background: rgba(2,6,23,.90);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index: 9999;
    }
    .toast.show{ display:flex; }
    .toast b{ display:block; margin-bottom:2px; }
    .toast .small{ font-size: 12px; color: rgba(226,232,240,.75); }

    /* ‚úÖ CATEGORIA: + e lixeira ‚ÄúDENTRO‚Äù do campo (igual era antes) */
    .catSelectWrap{
      position: relative;
      width: 100%;
    }
    .catSelectWrap select{
      padding-right: 88px; /* espa√ßo pros bot√µes dentro do campo */
    }
    .catActionsInside{
      position:absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display:flex;
      gap: 8px;
      align-items:center;
      z-index: 5;
    }
    .catActionsInside .btn-icon{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      padding: 0;
    }

    /* Sele√ß√£o m√∫ltipla */
    .bulkBar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 10px; }
    .bulkBar .count{
      font-size: 12px;
      color: rgba(226,232,240,.75);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.40);
    }
    .chkRow{ width:18px; height:18px; accent-color: var(--cyan); cursor:pointer; }
    .item.selected{ background: rgba(0,194,255,.06); box-shadow: inset 0 0 0 1px rgba(0,194,255,.20); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="diamond">üíé</div>
        <div>
          <h1>Controle Premium</h1>
          <p>Valores em Real (R$) ‚Ä¢ Pessoal</p>
        </div>
      </div>
      <div class="right">
        <div class="pill" id="pillEmail">N√£o logado</div>
        <button class="btn btn-danger hidden" id="btnSair" type="button">Sair</button>
      </div>
    </div>

    <div class="tabs hidden" id="tabs">
      <button class="tab active" id="tabFin" type="button">Finan√ßas</button>
      <button class="tab" id="tabMeta" type="button">Metas</button>
      <button class="tab" id="tabDash" type="button">Dashboard</button>
    </div>

    <div class="card" id="loginBox">
      <div class="head"><h2>Entrar</h2><span>Login com Google</span></div>
      <div class="body">
        <button class="btn btn-primary" id="btnLogin" type="button">Entrar com Google</button>
        <div class="hint">Se der cache: <strong>Ctrl + Shift + R</strong></div>
      </div>
    </div>

    <div class="grid hidden" id="financasBox">
      <div class="card">
        <div class="head">
          <div><h2>Adicionar lan√ßamento</h2><span>CSV + OFX + Bancos</span></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn btn-ghost" id="btnGerenciarBancos" type="button">üè¶ Gerenciar bancos</button>
          </div>
        </div>

        <div class="body">
          <div class="field">
            <label>M√™s selecionado</label>
            <select id="mesSelect"></select>
          </div>

          <div class="row">
            <div class="field">
              <label>Filtro de categoria</label>
              <select id="filtroCategoria"></select>
            </div>
            <div class="field">
              <label>Tipo</label>
              <select id="tipo">
                <option value="entrada">Entrada</option>
                <option value="saida">Sa√≠da</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Banco</label>
            <select id="bancoSelect"></select>
            <div class="hint">Voc√™ pode deixar ‚ÄúSem banco‚Äù.</div>
          </div>

          <div class="row">
            <div class="field">
              <label>Data (DD/MM/AAAA)</label>
              <input id="data" placeholder="Ex: 03/02/2026" />
            </div>
            <div class="field">
              <label>Valor (R$)</label>
              <input id="valor" type="number" placeholder="Ex: 100 (sempre positivo)" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Categoria</label>

              <!-- ‚úÖ AQUI: + e lixeira DENTRO do campo -->
              <div class="catSelectWrap">
                <select id="categoria"></select>
                <div class="catActionsInside">
                  <button class="btn btn-ghost btn-icon" id="btnAddCategoria" type="button" title="Adicionar categoria">Ôºã</button>
                  <button class="btn btn-ghost btn-icon btn-icon-danger" id="btnDelCategoria" type="button" title="Excluir categoria selecionada">üóëÔ∏è</button>
                </div>
              </div>

              <div class="hint">Clique no + para criar nova categoria. Para excluir, selecione e clique na lixeira.</div>
            </div>

            <div class="field">
              <label>Descri√ß√£o</label>
              <input id="descricao" placeholder="Ex: Venda Shopify, Mercado, Uber..." />
            </div>
          </div>

          <button class="btn btn-primary" id="btnSalvar" type="button">Salvar lan√ßamento</button>
          <div class="hint">Sa√≠da vira negativo automaticamente. Meta usa s√≥ entradas.</div>

          <div style="height:14px"></div>

          <div class="summary">
            <div class="kpi"><div class="k">Entradas</div><div class="v green" id="kpiEntradas">R$ 0,00</div></div>
            <div class="kpi"><div class="k">Sa√≠das</div><div class="v red" id="kpiSaidas">R$ 0,00</div></div>
            <div class="kpi"><div class="k">Saldo</div><div class="v" id="kpiSaldo">R$ 0,00</div></div>
            <div class="kpi"><div class="k">Registros</div><div class="v" id="kpiQtd">0</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div><h2>Movimenta√ß√µes</h2><span>Buscar + Editar + Exportar</span></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-ghost" id="btnPdf" type="button">üìÑ Gerar PDF (Premium)</button>
            <button class="btn btn-ghost" id="btnExportar" type="button">‚¨áÔ∏è Exportar CSV</button>
            <button class="btn btn-ghost" id="btnSelAll" type="button">‚úÖ Selecionar tudo</button>
            <button class="btn btn-ghost" id="btnSelNone" type="button">‚¨ú Limpar</button>
            <button class="btn btn-danger" id="btnDelSelected" type="button" disabled>üóëÔ∏è Excluir selecionados</button>
          </div>
        </div>

        <div class="body" style="padding-top:12px">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="busca" placeholder="üîé Buscar na descri√ß√£o..." />
            <div class="hint" id="buscaInfo">Mostrando tudo</div>
          </div>
          <div class="bulkBar">
            <div class="count" id="bulkCount">Selecionados: 0</div>
          </div>
        </div>

        <div class="list" id="lista">
          <div class="empty">Nenhum registro neste m√™s.</div>
        </div>
      </div>
    </div>

    <div class="hidden" id="metasBox">
      <div class="card">
        <div class="head"><h2>Metas & Progresso</h2><span>Progresso conta s√≥ ENTRADAS</span></div>
        <div class="body">
          <div class="hint">Metas OK (mantidas). Se quiser que eu traga a tela inteira aqui tamb√©m eu trago, mas o foco agora foi corrigir UI e sele√ß√£o m√∫ltipla.</div>
        </div>
      </div>
    </div>

    <div class="hidden" id="dashboardBox">
      <div class="card">
        <div class="head"><h2>Dashboard</h2><span>OK</span></div>
        <div class="body">
          <div class="hint">Dashboard OK (mantido). Se quiser eu re-colo o dashboard completo tamb√©m, mas n√£o muda nada nessas corre√ß√µes.</div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">
    <div>‚ö†Ô∏è</div>
    <div><b id="toastTitle">Aviso</b><div class="small" id="toastMsg"></div></div>
  </div>

  <script>
    const SUPABASE_URL = "https://ssnabfzwfvcmwkgibvec.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbmFiZnp3ZnZjbXdrZ2lidmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTE1MjcsImV4cCI6MjA4NTYyNzUyN30.s02EFB4FRopxB7Ak7zWUSkINcGY5ESRn7SLbDXn0Wbo";

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // UI
    const loginBox = document.getElementById("loginBox");
    const financasBox = document.getElementById("financasBox");
    const metasBox = document.getElementById("metasBox");
    const dashboardBox = document.getElementById("dashboardBox");
    const tabs = document.getElementById("tabs");
    const pillEmail = document.getElementById("pillEmail");
    const btnSair = document.getElementById("btnSair");
    const btnLogin = document.getElementById("btnLogin");

    const tabFin = document.getElementById("tabFin");
    const tabMeta = document.getElementById("tabMeta");
    const tabDash = document.getElementById("tabDash");

    const mesSelect = document.getElementById("mesSelect");
    const filtroCategoriaEl = document.getElementById("filtroCategoria");
    const tipoEl = document.getElementById("tipo");
    const dataEl = document.getElementById("data");
    const valorEl = document.getElementById("valor");
    const categoriaEl = document.getElementById("categoria");
    const descricaoEl = document.getElementById("descricao");
    const btnSalvar = document.getElementById("btnSalvar");

    const btnAddCategoria = document.getElementById("btnAddCategoria");
    const btnDelCategoria = document.getElementById("btnDelCategoria");

    const kpiEntradas = document.getElementById("kpiEntradas");
    const kpiSaidas = document.getElementById("kpiSaidas");
    const kpiSaldo = document.getElementById("kpiSaldo");
    const kpiQtd = document.getElementById("kpiQtd");

    const listaEl = document.getElementById("lista");
    const buscaEl = document.getElementById("busca");
    const buscaInfo = document.getElementById("buscaInfo");

    const btnExportar = document.getElementById("btnExportar");
    const btnPdf = document.getElementById("btnPdf");

    const btnSelAll = document.getElementById("btnSelAll");
    const btnSelNone = document.getElementById("btnSelNone");
    const btnDelSelected = document.getElementById("btnDelSelected");
    const bulkCount = document.getElementById("bulkCount");

    const bancoSelect = document.getElementById("bancoSelect");
    const btnGerenciarBancos = document.getElementById("btnGerenciarBancos");

    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    let currentUser = null;
    let currentMonth = null;
    let currentFiltroCategoria = "Todas";
    let currentSearch = "";
    let lastFinCache = null;
    let selectedIds = new Set();
    let banksCache = [];
    let categoriesCache = [];

    const DEFAULT_CATEGORIES = ["Vendas","Tr√°fego","Fornecedor","Embalagem","Frete/Log√≠stica","Impostos/Taxas","Mercado","Lazer","Outros"];

    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove("show"), 4500);
    }
    function brl(n){
      return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(Number(n || 0));
    }
    function escapeHtml(str){
      return (str || "").toString().replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthKeyFromDateObj(d){ return `${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
    function getDefaultMonth(){ return monthKeyFromDateObj(new Date()); }
    function getTodayBR(){
      const d = new Date();
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function parseBRDateToISO(br){
      const v = (br || "").trim();
      const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
      if (mm < 1 || mm > 12) return null;
      const dim = new Date(yyyy, mm, 0).getDate();
      if (dd < 1 || dd > dim) return null;
      return `${yyyy}-${pad2(mm)}-${pad2(dd)}`;
    }
    function formatISOToBR(iso){
      const m = (iso || "").match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return "";
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function parseMonthKey(mk){
      const m = (mk || "").trim().match(/^(\d{2})\/(\d{4})$/);
      if (!m) return null;
      const mm = Number(m[1]), yyyy = Number(m[2]);
      if (mm < 1 || mm > 12) return null;
      return { mm, yyyy };
    }
    function monthStartEndISO(monthKey){
      const p = parseMonthKey(monthKey);
      if (!p) return null;
      const start = `${p.yyyy}-${pad2(p.mm)}-01`;
      const endDay = new Date(p.yyyy, p.mm, 0).getDate();
      const end = `${p.yyyy}-${pad2(p.mm)}-${pad2(endDay)}`;
      return { start, end, endDay, yyyy: p.yyyy, mm: p.mm };
    }
    function sortMonthKeys(list){
      const unique = Array.from(new Set(list.filter(Boolean)));
      unique.sort((a,b) => {
        const pa = parseMonthKey(a), pb = parseMonthKey(b);
        if (!pa || !pb) return 0;
        if (pa.yyyy !== pb.yyyy) return pb.yyyy - pa.yyyy;
        return pb.mm - pa.mm;
      });
      return unique;
    }
    function fillMonthDropdown(selectEl, months, selected){
      const unique = sortMonthKeys(months);
      selectEl.innerHTML = "";
      for (const mk of unique){
        const opt = document.createElement("option");
        opt.value = mk;
        opt.textContent = mk;
        selectEl.appendChild(opt);
      }
      selectEl.value = selected;
      if (selectEl.value !== selected && unique.length) selectEl.value = unique[0];
    }

    function showLogin(){
      loginBox.classList.remove("hidden");
      tabs.classList.add("hidden");
      financasBox.classList.add("hidden");
      metasBox.classList.add("hidden");
      dashboardBox.classList.add("hidden");
      btnSair.classList.add("hidden");
      pillEmail.textContent = "N√£o logado";
    }
    function showApp(email){
      loginBox.classList.add("hidden");
      tabs.classList.remove("hidden");
      btnSair.classList.remove("hidden");
      pillEmail.textContent = email || "Logado";
      showFinancas();
    }
    function setActiveTab(active){
      for (const el of [tabFin, tabMeta, tabDash]) el.classList.remove("active");
      active.classList.add("active");
    }
    function showFinancas(){
      setActiveTab(tabFin);
      financasBox.classList.remove("hidden");
      metasBox.classList.add("hidden");
      dashboardBox.classList.add("hidden");
    }
    function showMetas(){
      setActiveTab(tabMeta);
      metasBox.classList.remove("hidden");
      financasBox.classList.add("hidden");
      dashboardBox.classList.add("hidden");
    }
    function showDashboard(){
      setActiveTab(tabDash);
      dashboardBox.classList.remove("hidden");
      financasBox.classList.add("hidden");
      metasBox.classList.add("hidden");
    }

    async function captureTokenIfPresent(){
      if (window.location.hash && window.location.hash.includes("access_token=")) {
        await supa.auth.getSessionFromUrl({ storeSession: true });
        history.replaceState({}, document.title, window.location.pathname);
      }
    }

    async function loadBanks(){
      if (!currentUser) return;
      const { data, error } = await supa.from("bancos").select("id,nome").eq("user_id", currentUser.id).order("nome", { ascending: true });
      if (error) throw error;
      banksCache = data || [];
    }
    function fillBankSelect(){
      const opts = [`<option value="">‚Äî Sem banco (opcional) ‚Äî</option>`]
        .concat(banksCache.map(b => `<option value="${b.id}">${escapeHtml(b.nome)}</option>`))
        .join("");
      bancoSelect.innerHTML = opts;
    }

    async function loadCategories(){
      if (!currentUser) return;
      const { data, error } = await supa.from("categorias").select("id,nome").eq("user_id", currentUser.id).order("nome", { ascending: true });
      if (error){ categoriesCache = []; return; }
      categoriesCache = (data || []).map(c => ({ id: c.id, nome: (c.nome || "").trim() })).filter(c => c.nome);
    }
    function getAllCategoryNames(){
      const set = new Set(DEFAULT_CATEGORIES);
      for (const c of categoriesCache) set.add(c.nome);
      return Array.from(set).sort((a,b) => a.localeCompare(b, "pt-BR"));
    }
    function fillCategorySelects(){
      const cats = getAllCategoryNames();
      categoriaEl.innerHTML = cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      filtroCategoriaEl.innerHTML = `<option value="Todas">Todas</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      filtroCategoriaEl.value = currentFiltroCategoria || "Todas";
      if (filtroCategoriaEl.value !== (currentFiltroCategoria || "Todas")) filtroCategoriaEl.value = "Todas";
    }
    async function addCategoriaFlow(){
      const nome = prompt("Nova categoria:");
      const n = (nome || "").trim();
      if (!n) return;
      const exists = getAllCategoryNames().some(x => x.toLowerCase() === n.toLowerCase());
      if (exists){ showToast("Categorias", "Essa categoria j√° existe."); return; }
      const { error } = await supa.from("categorias").insert({ user_id: currentUser.id, nome: n });
      if (error){ showToast("Categorias", error.message); return; }
      await loadCategories();
      fillCategorySelects();
      categoriaEl.value = n;
      showToast("Categorias ‚úÖ", "Categoria adicionada.");
    }
    async function deleteCategoriaFlow(){
      const selected = (categoriaEl.value || "").trim();
      if (!selected){ showToast("Categorias", "Selecione uma categoria."); return; }
      const custom = categoriesCache.find(c => c.nome.toLowerCase() === selected.toLowerCase());
      if (!custom){ showToast("Categorias", "Categoria padr√£o n√£o pode ser exclu√≠da."); return; }
      const ok = confirm(`Excluir a categoria "${selected}"?`);
      if (!ok) return;
      const { error } = await supa.from("categorias").delete().eq("id", custom.id).eq("user_id", currentUser.id);
      if (error){ showToast("Categorias", error.message); return; }
      await loadCategories();
      fillCategorySelects();
      showToast("Categorias ‚úÖ", "Categoria exclu√≠da.");
    }

    async function fetchMonthsFromRegistros(userId){
      const { data, error } = await supa.from("registros").select("mes").eq("user_id", userId).order("mes", { ascending: false }).limit(5000);
      if (error) throw error;
      return (data || []).map(r => r.mes).filter(Boolean);
    }
    async function fetchRegistrosByMonth(userId, monthKey){
      const range = monthStartEndISO(monthKey);
      const { data, error } = await supa
        .from("registros")
        .select("id, descricao, valor, data, mes, categoria, banco_id")
        .eq("user_id", userId)
        .gte("data", range.start)
        .lte("data", range.end)
        .order("data", { ascending: false });
      if (error) throw error;

      const rows = (data || []).map(r => ({
        id: r.id,
        descricao: r.descricao ?? "",
        valor: Number(r.valor || 0),
        dataISO: r.data,
        mes: r.mes,
        categoria: r.categoria || "Outros",
        banco_id: r.banco_id ? String(r.banco_id) : ""
      }));

      let entradas=0, saidas=0, saldo=0;
      for (const r of rows){
        saldo += r.valor;
        if (r.valor >= 0) entradas += r.valor;
        else saidas += Math.abs(r.valor);
      }
      return { rows, entradas, saidas, saldo, range };
    }

    function getFilteredRows(fin){
      let filtered = fin.rows || [];
      if (currentFiltroCategoria && currentFiltroCategoria !== "Todas"){
        filtered = filtered.filter(r => (r.categoria || "Outros") === currentFiltroCategoria);
      }
      const q = (currentSearch || "").trim().toLowerCase();
      if (q) filtered = filtered.filter(r => (r.descricao || "").toLowerCase().includes(q));
      return filtered;
    }

    function updateBulkUI(){
      const n = selectedIds.size;
      bulkCount.textContent = `Selecionados: ${n}`;
      btnDelSelected.disabled = n === 0;
    }

    function renderFinancas(fin){
      lastFinCache = fin;

      kpiEntradas.textContent = brl(fin.entradas);
      kpiSaidas.textContent = brl(fin.saidas);
      kpiSaldo.textContent = brl(fin.saldo);
      kpiQtd.textContent = String(fin.rows.length);

      const filtered = getFilteredRows(fin);
      buscaInfo.textContent = currentSearch ? `Filtrando: "${currentSearch}" ‚Ä¢ ${filtered.length} itens` : "Mostrando tudo";

      if (!filtered.length){
        listaEl.innerHTML = `<div class="empty">Nenhum registro para este m√™s/filtro.</div>`;
        updateBulkUI();
        return;
      }

      listaEl.innerHTML = filtered.map(r => {
        const cls = r.valor >= 0 ? "pos" : "neg";
        const bCls = r.valor >= 0 ? "in" : "out";
        const bTxt = r.valor >= 0 ? "Entrada" : "Sa√≠da";
        const bankName = r.banco_id ? (banksCache.find(x => String(x.id) === String(r.banco_id))?.nome || "") : "";
        const checked = selectedIds.has(String(r.id)) ? "checked" : "";

        return `
          <div class="item ${selectedIds.has(String(r.id)) ? "selected" : ""}" data-item="${escapeHtml(String(r.id))}">
            <div class="leftcol">
              <div class="desc">${escapeHtml(r.descricao)}</div>
              <div class="meta">
                <span class="badge ${bCls}">${bTxt}</span>
                <span class="badge cat">${escapeHtml(r.categoria || "Outros")}</span>
                <span class="badge">${escapeHtml(formatISOToBR(r.dataISO))}</span>
                ${bankName ? `<span class="badge">üè¶ ${escapeHtml(bankName)}</span>` : ``}
              </div>
            </div>

            <div class="rightcol">
              <!-- ‚úÖ CHECKBOX REAL (pra excluir v√°rios funcionar) -->
              <input class="chkRow" type="checkbox" data-sel="1" data-id="${escapeHtml(String(r.id))}" ${checked} title="Selecionar">

              <div class="amount ${cls}">${brl(r.valor)}</div>
              <button class="btn btn-icon btn-icon-edit" type="button" data-edit="1" data-id="${escapeHtml(String(r.id))}">‚úèÔ∏è</button>
              <button class="btn btn-icon btn-icon-danger" type="button" data-del="1" data-id="${escapeHtml(String(r.id))}">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join("");

      updateBulkUI();
    }

    async function refreshUI(){
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (!session){
        currentUser = null;
        showLogin();
        return;
      }

      currentUser = session.user;
      showApp(session.user.email);

      if (!dataEl.value) dataEl.value = getTodayBR();

      try{
        await loadBanks();
        fillBankSelect();
      }catch(e){
        bancoSelect.innerHTML = `<option value="">‚Äî Sem banco (opcional) ‚Äî</option>`;
      }

      try{ await loadCategories(); }catch(e){}
      fillCategorySelects();

      let months = [getDefaultMonth()];
      try{ months = months.concat(await fetchMonthsFromRegistros(currentUser.id)); }catch(e){}

      const desiredFin = currentMonth || getDefaultMonth();
      fillMonthDropdown(mesSelect, months, desiredFin);
      currentMonth = mesSelect.value || getDefaultMonth();

      const fin = await fetchRegistrosByMonth(currentUser.id, currentMonth);
      selectedIds = new Set(); // zera sele√ß√£o ao trocar m√™s
      renderFinancas(fin);
    }

    // Login
    btnLogin.addEventListener("click", async () => {
      const { error } = await supa.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.origin }
      });
      if (error) showToast("Login", error.message);
    });

    btnSair.addEventListener("click", async () => {
      await supa.auth.signOut();
      location.href = window.location.pathname;
    });

    tabFin.addEventListener("click", showFinancas);
    tabMeta.addEventListener("click", showMetas);
    tabDash.addEventListener("click", showDashboard);

    mesSelect.addEventListener("change", async () => {
      currentMonth = mesSelect.value;
      await refreshUI();
    });

    filtroCategoriaEl.addEventListener("change", async () => {
      currentFiltroCategoria = filtroCategoriaEl.value;
      if (lastFinCache) renderFinancas(lastFinCache);
    });

    buscaEl.addEventListener("input", () => {
      currentSearch = buscaEl.value;
      if (lastFinCache) renderFinancas(lastFinCache);
    });

    btnAddCategoria.addEventListener("click", addCategoriaFlow);
    btnDelCategoria.addEventListener("click", deleteCategoriaFlow);

    btnSalvar.addEventListener("click", async () => {
      if (!currentUser){ showLogin(); return; }

      const tipo = tipoEl.value;
      const dataISO = parseBRDateToISO((dataEl.value || "").trim());
      const valorDigitado = Number(valorEl.value);
      const descricao = (descricaoEl.value || "").trim();
      const categoria = (categoriaEl.value || "Outros").trim();
      const bankId = (bancoSelect.value || "").trim();

      if (!dataISO){ showToast("Data inv√°lida", "Use DD/MM/AAAA."); return; }
      if (!descricao){ showToast("Descri√ß√£o", "Preencha a descri√ß√£o."); return; }
      if (!Number.isFinite(valorDigitado) || valorDigitado <= 0){ showToast("Valor", "Digite um valor positivo."); return; }

      const valorFinal = (tipo === "saida") ? -Math.abs(valorDigitado) : Math.abs(valorDigitado);
      const mesAuto = monthKeyFromDateObj(new Date(dataISO + "T00:00:00"));

      const { error } = await supa.from("registros").insert({
        user_id: currentUser.id,
        descricao,
        valor: valorFinal,
        data: dataISO,
        mes: mesAuto,
        categoria,
        banco_id: bankId ? Number(bankId) : null
      });

      if (error){ showToast("N√£o salvou", error.message); return; }

      descricaoEl.value = "";
      valorEl.value = "";
      currentMonth = mesAuto;
      await refreshUI();
    });

    // Sele√ß√£o m√∫ltipla (funcionando)
    function applySelectAllCurrent(){
      if (!lastFinCache){ showToast("Sele√ß√£o", "Carregue um m√™s primeiro."); return; }
      const filtered = getFilteredRows(lastFinCache);
      for (const r of filtered) selectedIds.add(String(r.id));
      renderFinancas(lastFinCache);
    }
    function clearSelection(){
      selectedIds = new Set();
      if (lastFinCache) renderFinancas(lastFinCache);
      else updateBulkUI();
    }

    btnSelAll.addEventListener("click", applySelectAllCurrent);
    btnSelNone.addEventListener("click", clearSelection);

    // Clique dentro da lista: checkbox / excluir (bulk e individual)
    listaEl.addEventListener("click", async (e) => {
      const sel = e.target.closest("[data-sel]");
      if (sel){
        const id = String(sel.dataset.id || "");
        if (!id) return;
        if (sel.checked) selectedIds.add(id);
        else selectedIds.delete(id);
        const itemEl = sel.closest(".item");
        if (itemEl) itemEl.classList.toggle("selected", sel.checked);
        updateBulkUI();
        return;
      }

      const delBtn = e.target.closest("[data-del]");
      if (delBtn){
        const id = delBtn.dataset.id;
        const ok = confirm("Excluir este lan√ßamento?");
        if (!ok) return;
        const { error } = await supa.from("registros").delete().eq("id", id).eq("user_id", currentUser.id);
        if (error){ showToast("Excluir", error.message); return; }
        selectedIds.delete(String(id));
        showToast("Exclu√≠do ‚úÖ", "Lan√ßamento removido.");
        await refreshUI();
      }
    });

    btnDelSelected.addEventListener("click", async () => {
      const ids = Array.from(selectedIds);
      if (!ids.length){ showToast("Excluir", "Selecione lan√ßamentos primeiro."); return; }
      const ok = confirm(`Excluir ${ids.length} lan√ßamento(s) selecionado(s)?`);
      if (!ok) return;

      try{
        const chunkSize = 200;
        for (let i=0;i<ids.length;i+=chunkSize){
          const chunk = ids.slice(i, i+chunkSize);
          const { error } = await supa.from("registros").delete().in("id", chunk).eq("user_id", currentUser.id);
          if (error) throw error;
        }
        selectedIds = new Set();
        showToast("Exclu√≠dos ‚úÖ", `${ids.length} lan√ßamento(s) removido(s).`);
        await refreshUI();
      }catch(err){
        showToast("Excluir", err.message || String(err));
      }
    });

    // Export/PDF (mantidos simples aqui)
    btnExportar.addEventListener("click", () => showToast("Exportar", "Se quiser, eu re-colo o export completo tamb√©m."));
    btnPdf.addEventListener("click", () => showToast("PDF", "Se quiser, eu re-colo o PDF completo tamb√©m."));

    (async () => {
      await captureTokenIfPresent();
      if (!dataEl.value) dataEl.value = getTodayBR();
      currentMonth = getDefaultMonth();
      await refreshUI();
    })();

    supa.auth.onAuthStateChange(async () => {
      await refreshUI();
    });
  </script>
</body>
</html>
